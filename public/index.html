<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phixo Admin</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f4f0;--surface:#fff;--surface-2:#f9f8f5;--border:#e4e2d8;
  --text:#16160e;--muted:#8c8a78;--accent:#c8a96e;--accent-light:#faf4ea;
  --nav:#111108;--nav2:#1a1a0f;--nav-text:#777760;--nav-active:#fff;
  --hot:#d94040;--warm:#c07820;--cold:#3a7abd;
  --tof:#4a7c59;--mof:#5a6a9e;--bof:#9e5a5a;
  --r:10px;--sh:0 2px 16px rgba(0,0,0,.07);--nw:220px
}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}
#nav{width:var(--nw);min-height:100vh;background:var(--nav);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;border-right:1px solid #1e1e12}
.nav-logo{padding:22px 20px 16px;font-size:16px;font-weight:700;color:#fff}
.nav-logo span{color:var(--accent)}
.nav-section{padding:14px 12px 4px;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:#383828;font-weight:600}
.nb{display:flex;align-items:center;gap:9px;padding:8px 12px;margin:1px 6px;border-radius:7px;cursor:pointer;font-size:13px;font-weight:500;color:var(--nav-text);border:none;background:none;width:calc(100% - 12px);text-align:left;transition:all .12s}
.nb:hover{background:var(--nav2);color:#ccc}
.nb.on{background:#222214;color:var(--nav-active)}
.nb .ico{font-size:13px;width:16px;text-align:center}
.nav-foot{margin-top:auto;padding:16px 14px;border-top:1px solid #1a1a10}
.nav-foot a{display:block;font-size:11px;color:#444430;text-decoration:none;margin-top:3px}
.dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#4a9;margin-right:5px}
#main{margin-left:var(--nw);flex:1;min-height:100vh}
.view{display:none;padding:36px 40px;max-width:1100px}
.view.on{display:block}
.ph{margin-bottom:26px}
.ph h1{font-size:22px;font-weight:800;letter-spacing:-.4px}
.ph h1 em{font-style:normal;color:var(--accent)}
.ph p{color:var(--muted);font-size:13px;margin-top:3px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .12s;white-space:nowrap;font-family:inherit}
.btn-dark{background:var(--text);color:#fff}.btn-dark:hover{background:#2a2a18}
.btn-ghost{background:var(--bg);color:var(--text);border:1px solid var(--border)}.btn-ghost:hover{background:var(--border)}
.btn-accent{background:var(--accent);color:#fff}.btn-accent:hover{background:#b8955a}
.btn-danger{background:#fff0f0;color:var(--hot);border:1px solid #fcc}.btn-danger:hover{background:#ffe0e0}
.btn-sm{padding:5px 11px;font-size:12px}.btn-xs{padding:3px 8px;font-size:11px}
.btn:disabled{opacity:.4;cursor:not-allowed}
input,select,textarea{width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:7px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);outline:none;transition:border .12s}
input:focus,select:focus,textarea:focus{border-color:var(--accent);background:#fff}
textarea{resize:vertical;min-height:70px;line-height:1.55}
label{font-size:10px;font-weight:700;color:var(--muted);display:block;margin-bottom:3px;margin-top:12px;text-transform:uppercase;letter-spacing:.5px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700}
.t-lead{background:#f0efe8;color:#666}.t-booked{background:#e8f5e9;color:#2a7a2a}
.t-shot{background:#e3f2fd;color:#1255aa}.t-delivered{background:#f3e5f5;color:#6a1b9a}
.t-watching{background:#f0efe8;color:#777}.t-outreach{background:#fff3e0;color:#b06000}
.t-contacted{background:#e8f0fe;color:#3050aa}.t-notfit{background:#fdeaea;color:#aa2020}
.t-hot{background:#fdeaea;color:var(--hot)}.t-warm{background:#fff3e0;color:var(--warm)}.t-cold{background:#e8f0fd;color:var(--cold)}
.tb{display:flex;gap:8px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.tb input,.tb select{width:auto}
.tb input{min-width:200px}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;cursor:pointer;transition:all .12s;box-shadow:var(--sh)}
.card:hover{border-color:var(--accent);transform:translateY(-1px)}
.card h3{font-size:14px;font-weight:700;margin-bottom:2px;line-height:1.3}
.card .meta{font-size:12px;color:var(--muted);margin-bottom:10px}
.card .foot{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.block-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.block-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:all .12s;box-shadow:var(--sh)}
.block-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.block-thumb{height:180px;background:#f0efe8;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.block-thumb img{max-width:100%;max-height:100%;object-fit:contain;width:auto;height:auto}
.type-badge{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.55);color:#fff;font-size:9px;padding:2px 6px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px}
.block-body{padding:10px 12px}
.block-title{font-size:12px;font-weight:600;line-height:1.35;margin-bottom:4px}
.block-meta{font-size:11px;color:var(--muted)}
.block-tags{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.block-tags span{background:var(--bg);border-radius:20px;padding:1px 6px;font-size:10px;color:var(--muted)}
.funnel-label{font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;display:inline-block}
.fl-tof{background:#e8f4ec;color:var(--tof)}.fl-mof{background:#eef0fa;color:var(--mof)}.fl-bof{background:#faeaea;color:var(--bof)}
.cf-header{background:var(--nav);color:#fff;border-radius:var(--r);padding:24px 28px;margin-bottom:8px}
.cf-brand{font-size:9px;letter-spacing:3px;text-transform:uppercase;opacity:.35;margin-bottom:8px}
.cf-name{font-size:28px;font-weight:800;letter-spacing:-.5px}
.cf-meta{font-size:13px;opacity:.5;margin-top:3px}
.cf-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px}
.cf-sec{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;box-shadow:var(--sh);overflow:hidden}
.cf-sh{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;cursor:pointer;user-select:none;border-bottom:1px solid var(--border)}
.cf-sh h3{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--muted)}
.cf-sh .arr{font-size:10px;color:var(--muted);transition:transform .15s}
.cf-sh.open .arr{transform:rotate(180deg)}
.cf-bd{padding:0 20px 16px}
.cf-bd.hide{display:none}
.hide{display:none!important}
.cf-row{display:grid;grid-template-columns:170px 1fr;gap:10px;padding:9px 0;border-bottom:1px solid var(--bg);align-items:start}
.cf-row:last-child{border-bottom:none}
.cf-key{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);padding-top:2px}
.cf-val{font-size:13px;line-height:1.55}
.cf-val.editable{cursor:pointer;padding:3px 7px;margin:-3px -7px;border-radius:5px;border:1px solid transparent}
.cf-val.editable:hover{background:var(--bg);border-color:var(--border)}
.cf-val.empty{color:var(--muted);font-style:italic}
.temp-badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;margin-bottom:3px}
.conv-block{white-space:pre-wrap;font-size:13px;line-height:1.6;background:var(--bg);padding:14px;border-radius:8px;max-height:350px;overflow-y:auto}
.draft-block{background:var(--accent-light);border:1px solid #e8d5a8;border-radius:8px;padding:14px 16px;font-size:13px;line-height:1.6}
.back-btn{background:none;border:none;font-size:13px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:5px;margin-bottom:16px;padding:0;font-family:inherit}
.back-btn:hover{color:var(--text)}
.block-strip{display:flex;gap:8px;flex-wrap:wrap;padding:4px 0}
.strip-thumb{position:relative;width:90px;height:90px;border-radius:8px;overflow:hidden;border:2px solid var(--border);flex-shrink:0}
.strip-thumb img{width:100%;height:100%;object-fit:cover}
.strip-thumb .rm{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.65);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.strip-add{width:90px;height:90px;border-radius:8px;border:2px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:11px;gap:3px;background:none;font-family:inherit;flex-shrink:0;transition:all .12s}
.strip-add:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
.strip-add .ico{font-size:20px}
/* Pose grid */
.pose-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:4px 0}
.pose-tile{position:relative;border-radius:12px;overflow:hidden;background:var(--surface-2);aspect-ratio:3/4;cursor:pointer;border:2px solid transparent;transition:all .15s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.pose-tile:hover{border-color:var(--accent);transform:translateY(-2px)}
.pose-tile img{width:100%;height:100%;object-fit:cover}
.pose-tile .rm{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .1s}
.pose-tile:hover .rm{opacity:1}
.pose-tile-add{aspect-ratio:3/4;border-radius:10px;border:2px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:12px;gap:6px;background:none;font-family:inherit;transition:all .12s;min-height:120px}
.pose-tile-add:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}
/* Lightbox */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out}
.lightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px}
.lightbox-close{position:absolute;top:20px;right:24px;background:none;border:none;color:#fff;font-size:28px;cursor:pointer;opacity:.7}
.lightbox-close:hover{opacity:1}
.kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kcol{background:var(--bg);border-radius:var(--r);padding:12px}
.kcol-head{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px}
.kcard{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:7px;cursor:pointer;transition:all .12s}
.kcard:hover{border-color:var(--accent)}
.kcard .plat{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:4px}
.kcard .goal{font-size:13px;font-weight:600;line-height:1.35}
.kcard .kdate{font-size:11px;color:var(--muted);margin-top:5px}
/* Month Calendar */
.month-nav{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.month-day-header{background:var(--surface-2);padding:10px;text-align:center;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted)}
.month-day{background:var(--surface);min-height:100px;padding:6px;position:relative;border:1px solid transparent;transition:all .15s}
.month-day:hover{background:var(--bg);border-color:var(--accent)}
.month-day.other-month{background:#fafaf8;opacity:.4}
.month-day.today{background:var(--accent-light);border:2px solid var(--accent)}
.month-day-num{font-size:12px;font-weight:700;color:var(--text);margin-bottom:4px}
.month-day.other-month .month-day-num{color:var(--muted)}
.month-post{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:4px 6px;margin-bottom:4px;font-size:11px;cursor:pointer;transition:all .12s}
.month-post:hover{border-color:var(--accent);transform:translateX(2px)}
.month-post.status-idea{border-left:3px solid #ccc}
.month-post.status-draft{border-left:3px solid #f0ad4e}
.month-post.status-ready{border-left:3px solid #5cb85c}
.month-post.status-posted{border-left:3px solid #5bc0de}
.month-post-title{font-weight:600;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.month-post-meta{font-size:10px;color:var(--muted)}
.month-day-add{font-size:20px;color:var(--muted);cursor:pointer;opacity:0;transition:opacity .12s;position:absolute;bottom:6px;right:6px}
.month-day:hover .month-day-add{opacity:1}
.month-day-add:hover{color:var(--accent)}
.pb-layout{display:grid;grid-template-columns:1fr 300px;gap:20px;align-items:start}
.pb-stack{display:flex;flex-direction:column;gap:6px}
.module{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.module.dragging{opacity:.5;border:2px dashed var(--accent)}
.module-head{display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:move;user-select:none;border-bottom:1px solid var(--border);background:var(--bg)}
.module-head .mtype{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted)}
.module-head .drag{color:#ccc;font-size:12px}
.module-body{padding:10px 14px}
.module-body textarea{min-height:50px}
.module-actions{display:flex;gap:5px;margin-left:auto}
.pb-sidebar{position:sticky;top:20px}
.pbs-inner{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.pbs-head{padding:12px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted)}
.pbs-f{display:flex;flex-direction:column;gap:6px;padding:8px 10px;border-bottom:1px solid var(--border)}
.pbs-f input,.pbs-f select{font-size:12px;padding:5px 9px}
.pbs-blocks{max-height:360px;overflow-y:auto;padding:6px}
.pbs-block{display:flex;align-items:center;gap:8px;padding:6px 7px;border-radius:7px;cursor:pointer;border:1px solid transparent;transition:all .12s}
.pbs-block:hover{background:var(--bg);border-color:var(--border)}
.pbs-block .pi{font-size:18px;flex-shrink:0}
.pbs-block .pt{font-size:12px;font-weight:600;line-height:1.3}
.pbs-block .pm{font-size:11px;color:var(--muted)}
.pbs-empty{font-size:12px;color:var(--muted);padding:14px;text-align:center}
.assist-panel{background:var(--nav);border-radius:var(--r);overflow:hidden;margin-top:10px}
.assist-head{padding:10px 12px;border-bottom:1px solid #1e1e12}
.assist-head .at{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#555540;margin-bottom:2px}
.assist-head .as{font-size:11px;color:#666650;line-height:1.4}
.assist-msgs{height:220px;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:5px}
.am{font-size:12px;line-height:1.5;padding:7px 9px;border-radius:6px;max-width:92%}
.am-ai{background:#1c1c0e;color:#bbb;align-self:flex-start}
.am-user{background:var(--accent);color:#fff;align-self:flex-end}
.assist-ir{padding:7px 9px;border-top:1px solid #1e1e12;display:flex;gap:6px}
.assist-ir input{flex:1;background:#161608;border-color:#282818;color:#ccc;font-size:12px;padding:6px 9px}
.assist-qr{padding:5px 9px 9px;display:flex;gap:4px;flex-wrap:wrap}
.aq{background:#161608;border:1px solid #282818;color:#666;border-radius:5px;padding:3px 7px;font-size:10px;cursor:pointer;font-family:inherit}
.aq:hover{background:#1e1e0e;color:#aaa;border-color:#444}
.hook-item{padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px;line-height:1.4}
.hook-item:hover{background:var(--accent-light)}
.hook-item:last-child{border-bottom:none}
.hook-cat{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:2px}
.bpm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;max-height:380px;overflow-y:auto}
.bpm-card{border:2px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer;transition:all .12s}
.bpm-card:hover{border-color:var(--accent)}
.bpm-card.sel{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.bpm-thumb{height:80px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:28px;overflow:hidden}
.bpm-thumb img{max-width:100%;max-height:100%;object-fit:contain;width:auto;height:auto}
.bpm-label{font-size:11px;padding:5px 7px;font-weight:600;line-height:1.3;border-top:1px solid var(--border)}
.drive-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;max-height:360px;overflow-y:auto}
.drive-card{border:2px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer;transition:all .12s;position:relative}
.drive-card.imported{border-color:#4a7c5940}
.drive-card.imported .dname{color:#4a7c59}
.drive-card:hover{border-color:var(--accent)}
.drive-card.sel{border-color:var(--accent)}
.drive-card img{width:100%;height:80px;object-fit:contain;background:#f0efe8;display:block}
.drive-icon{height:75px;display:flex;align-items:center;justify-content:center;font-size:28px;background:var(--bg)}
.dname{font-size:10px;padding:3px 5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid var(--border)}
.drive-check{position:absolute;top:3px;right:3px;background:var(--accent);color:#fff;width:16px;height:16px;border-radius:50%;font-size:9px;display:none;align-items:center;justify-content:center;font-weight:700}
.drive-card.sel .drive-check{display:flex}
.drive-imported{position:absolute;top:3px;left:3px;background:rgba(74,124,89,.85);color:#fff;font-size:8px;padding:1px 5px;border-radius:20px;letter-spacing:.4px;font-weight:700}
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}
.mbg.off{display:none}
.modal{background:var(--surface);border-radius:14px;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.22)}
.modal.wide{max-width:820px}
.mh{padding:20px 24px 0;display:flex;align-items:center;justify-content:space-between}
.mh h2{font-size:17px;font-weight:700}
.mx{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);padding:4px;line-height:1;font-family:inherit}
.mb{padding:16px 24px 24px}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:14px}
.tab{padding:8px 16px;font-size:13px;font-weight:600;border:none;background:none;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;font-family:inherit}
.tab.on{color:var(--text);border-bottom-color:var(--accent)}
.tc{display:none}.tc.on{display:block}
.empty{text-align:center;padding:50px 20px;color:var(--muted)}
.empty .ei{font-size:40px;margin-bottom:12px}

.video-block{display:flex;flex-direction:column;gap:0}
.vb-hero{position:relative;background:#111;border-radius:10px;overflow:hidden;margin-bottom:16px}
.vb-hero img{width:100%;max-height:320px;object-fit:contain;display:block}
.vb-platform{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.7);color:#fff;font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;text-transform:uppercase;letter-spacing:.8px}
.vb-dur{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;font-size:11px;padding:2px 8px;border-radius:20px}
.vb-meta{margin-bottom:14px}
.vb-oneliner{font-size:14px;font-weight:600;line-height:1.45;margin-bottom:6px}
.vb-relevance{font-size:12px;color:var(--muted);line-height:1.5;background:var(--bg);padding:8px 12px;border-radius:7px;border-left:3px solid var(--accent)}
.vb-section{margin-bottom:16px}
.vb-section-head{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.vb-section-head::after{content:'';flex:1;height:1px;background:var(--border)}
.kp-list{display:flex;flex-direction:column;gap:5px}
.kp-item{display:flex;align-items:start;gap:9px;background:var(--bg);padding:8px 11px;border-radius:7px;font-size:13px;line-height:1.45}
.kp-num{font-size:11px;font-weight:800;color:var(--accent);min-width:18px;padding-top:1px}
.shots-strip{display:flex;gap:7px;overflow-x:auto;padding:2px 0 8px;scrollbar-width:thin}
.shots-strip::-webkit-scrollbar{height:4px}
.shots-strip::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.shot-frame{flex-shrink:0;width:120px}
.shot-frame img{width:120px;height:80px;object-fit:contain;background:#111;border-radius:7px;display:block}
.shot-label{font-size:10px;color:var(--muted);text-align:center;margin-top:3px}
.transcript-block{background:var(--bg);border-radius:8px;padding:14px 16px;font-size:13px;line-height:1.9;color:var(--text);max-height:400px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;border:1px solid var(--border);font-family:inherit}
.vb-source{font-size:11px;color:var(--muted);margin-top:10px}
.vb-source a{color:var(--accent)}
.progress-card{background:var(--nav);border-radius:12px;padding:28px;text-align:center;min-height:200px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.progress-spinner{width:36px;height:36px;border:3px solid #333;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-step{font-size:13px;color:#aaa;max-width:280px;line-height:1.5}
.progress-step strong{color:#fff;display:block;margin-bottom:4px}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--nav);color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none}
.toast.on{opacity:1}.toast.ok{background:#2a7a2a}.toast.err{background:var(--hot)}

/* Knowledge base */
.kb-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px}
.kb-answer{background:var(--surface-2);border-radius:8px;padding:14px;font-size:13px;line-height:1.7;white-space:pre-wrap;margin-top:12px;max-height:400px;overflow-y:auto}
.kb-sources{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.kb-source-chip{background:var(--accent-light);color:var(--accent);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer}
.kb-source-chip:hover{background:var(--accent);color:#fff}
.block-video-player{width:100%;border-radius:8px;margin-bottom:12px;max-height:380px;background:#000}
.script-content{background:var(--surface-2);border-radius:8px;padding:14px;font-size:12.5px;line-height:1.8;white-space:pre-wrap;font-family:'SF Mono',Consolas,monospace;max-height:380px;overflow-y:auto;margin-bottom:10px}
.summarize-btn{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:12px;cursor:pointer;font-family:inherit}
.summarize-btn:hover{opacity:.85}
.summarize-btn:disabled{opacity:.5;cursor:default}
/* v3.44 Post Builder */
.content-type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.ct-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:30px;text-align:center;cursor:pointer;transition:all .15s}
.ct-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.ct-icon{font-size:48px;margin-bottom:12px}
.ct-title{font-size:16px;font-weight:700;margin-bottom:6px}
.ct-desc{font-size:13px;color:var(--muted)}
.pb-header{display:flex;align-items:start;justify-content:space-between;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)}
.pb-header h2{font-size:20px;font-weight:800;margin-bottom:8px}
.pb-layout{display:grid;grid-template-columns:1fr 320px;gap:24px}
.pb-main{display:flex;flex-direction:column;gap:16px}
.content-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.cb-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.cb-icon{font-size:20px}
.cb-title{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text)}
.cb-hint{font-size:11px;color:var(--muted);margin-left:auto}
.cb-tips{margin-top:10px;padding:10px 12px;background:var(--accent-light);border-radius:6px;font-size:12px;line-height:1.5;color:#7a6c45}
.content-textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:13px;line-height:1.6;resize:vertical;background:var(--bg)}
.content-textarea:focus{border-color:var(--accent);outline:none;background:#fff}
.content-input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:13px}
.content-input:focus{border-color:var(--accent);outline:none;background:#fff}
.hook-search-wrapper{position:relative}
.hook-input{width:100%;padding:12px 14px;border:2px solid var(--accent);border-radius:8px;font-size:14px;font-weight:500;background:#fff}
.hook-input:focus{outline:none;border-color:var(--warm)}
.hook-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-top:4px;max-height:300px;overflow-y:auto;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.hook-result{padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
.hook-result:last-child{border-bottom:none}
.hook-result:hover{background:var(--accent-light)}
.hook-text{font-size:13px;font-weight:500;margin-bottom:4px}
.hook-category{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.hook-no-results{padding:20px;text-align:center;font-size:12px;color:var(--muted)}
.pb-preview{position:sticky;top:20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.preview-header{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px}
.preview-body{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px;font-size:13px;line-height:1.7;white-space:pre-wrap;min-height:200px;max-height:400px;overflow-y:auto;color:var(--text)}
.preview-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.preview-stat{text-align:center}
.ps-label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:4px}
.ps-value{display:block;font-size:14px;font-weight:700}
.mini-select{padding:5px 10px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--bg)}
/* v3.44 Simplified */
.type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.type-card{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .15s}
.type-card:hover{border-color:var(--accent);transform:translateY(-4px)}
.type-icon{font-size:56px;margin-bottom:12px}
.type-title{font-size:18px;font-weight:700}
.pb-simple{max-width:1400px;margin:0 auto}
.pb-top{margin-bottom:24px}
.pb-top h2{font-size:22px;font-weight:800;margin-bottom:12px;display:flex;align-items:center}
.pb-meta-row{display:flex;gap:8px;align-items:center}
.pb-cols{display:grid;grid-template-columns:280px 1fr 300px;gap:24px}
.pb-refs{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;max-height:calc(100vh - 200px);overflow-y:auto}
.pb-refs-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.ref-search{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;margin-bottom:12px}
.ref-blocks{display:flex;flex-direction:column;gap:6px}
.ref-block{display:flex;align-items:start;gap:8px;padding:8px;border-radius:6px;cursor:pointer;border:1px solid transparent;transition:all .12s}
.ref-block:hover{background:var(--bg);border-color:var(--border)}
.ref-icon{font-size:20px;flex-shrink:0}
.ref-info{flex:1;min-width:0}
.ref-title{font-size:12px;font-weight:600;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ref-snippet{font-size:10px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.attached-block{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:var(--accent-light);border-radius:6px;font-size:11px;margin-bottom:4px}
.pb-caption{display:flex;flex-direction:column;gap:16px}
.cs-label{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.caption-input,.caption-textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;font-family:inherit}
.caption-input:focus,.caption-textarea:focus{outline:none;border-color:var(--accent)}
.caption-textarea{resize:vertical;line-height:1.6}
.pb-preview-col{position:sticky;top:20px}
.preview-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.preview-label{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:12px}
.preview-caption{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:12px;min-height:200px;max-height:400px;overflow-y:auto;font-size:13px;line-height:1.7;white-space:pre-wrap;margin-bottom:12px}
.preview-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.preview-stats > div{text-align:center}
.stat-num{display:block;font-size:18px;font-weight:700}
.stat-label{display:block;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.hook-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:9999}
.hook-modal-content{background:var(--surface);border-radius:12px;width:90%;max-width:700px;max-height:80vh;display:flex;flex-direction:column}
.hook-modal-head{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.hook-modal-head h3{font-size:18px;font-weight:700}
.hook-modal-head button{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
.hook-modal-search{margin:16px 20px;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px}
.hook-modal-search:focus{outline:none;border-color:var(--accent)}
.hook-modal-results{flex:1;overflow-y:auto;padding:0 20px 20px}
.hook-modal-item{padding:14px 16px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .12s;font-size:14px;line-height:1.6}
.hook-modal-item:hover{background:var(--accent-light);border-color:var(--accent)}
.hook-cat{display:inline-block;margin-left:8px;padding:2px 6px;background:var(--bg);border-radius:4px;font-size:10px;color:var(--muted);text-transform:uppercase}
.hook-empty{padding:40px;text-align:center;color:var(--muted);font-size:14px}
.hook-loading{padding:20px;text-align:center;color:var(--muted);font-size:13px;font-style:italic}
.btn-link{background:none;border:none;color:var(--accent);cursor:pointer;padding:0;font:inherit}
.btn-link:hover{text-decoration:underline}
.btn-xs{padding:2px 6px;font-size:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;cursor:pointer}
.btn-xs:hover{background:var(--border)}
</style>
</head>
<body>
<nav id="nav">
  <div class="nav-logo">Phixo <span>Admin</span></div>
  <div class="nav-section">Clients</div>
  <button class="nb on" data-view="pipeline" onclick="showView('pipeline',this)"><span class="ico">ğŸ‘¤</span> Pipeline</button>
  <button class="nb" onclick="openNewClient()"><span class="ico">ï¼‹</span> New Client</button>
  <button class="nb" data-view="discovery" onclick="showView('discovery',this)"><span class="ico">ğŸ”­</span> Discovery</button>
  <button class="nb" onclick="openNewProspect()"><span class="ico">ï¼‹</span> New Target</button>
  <div class="nav-section">Research</div>
  <button class="nb" data-view="research" onclick="showView('research',this)"><span class="ico">ğŸ“š</span> All Blocks</button>
  <button class="nb" onclick="openAddBlock()"><span class="ico">ï¼‹</span> Add Block</button>
  <div class="nav-section">Content</div>
  <button class="nb" data-view="calendar" onclick="showView('calendar',this)"><span class="ico">ğŸ“…</span> Calendar</button>
  <button class="nb" onclick="openNewPost()"><span class="ico">âœï¸</span> New Post</button>
  <div class="nav-foot">
    <span><span class="dot"></span>Connected</span>
    <a href="/auth/logout">Sign out</a>
  </div>
</nav>
<button id="ask-fab" onclick="openAskLibrary()" title="Ask your library" style="position:fixed;bottom:24px;right:24px;z-index:200;background:var(--accent);color:#fff;border:none;border-radius:50%;width:52px;height:52px;font-size:22px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;transition:transform .15s" onmouseenter="this.style.transform='scale(1.1)'" onmouseleave="this.style.transform='scale(1)'">ğŸ§ </button>
<div id="main">
<div id="v-pipeline" class="view on">
  <div class="ph"><h1>Client <em>pipeline</em></h1><p>Active leads, bookings, and deliveries.</p></div>
  <div class="tb">
    <input type="text" id="pl-search" placeholder="Search clients..." oninput="debouncedLoad('loadPipeline')">
    <select id="pl-status" onchange="loadPipeline()" style="width:140px">
      <option value="">All statuses</option>
      <option value="lead">Lead</option><option value="booked">Booked</option>
      <option value="shot">Shot</option><option value="delivered">Delivered</option>
    </select>
    <button class="btn btn-ghost btn-sm" onclick="syncClients()" title="Import client folders from Drive">â†» Sync from Drive</button>
    <button class="btn btn-dark btn-sm" onclick="openNewClient()">+ New Client</button>
  </div>
  <div id="pipeline-grid" class="card-grid"></div>
</div>
<div id="v-client-file" class="view">
  <button class="back-btn" onclick="showView('pipeline')">â† Pipeline</button>
  <div id="cf-body"></div>
</div>
<div id="v-discovery" class="view">
  <div class="ph"><h1>Discovery <em>board</em></h1><p>Who do you want to shoot next?</p></div>
  <div class="tb">
    <input type="text" id="disc-search" placeholder="Search targets..." oninput="debouncedLoad('loadDiscovery')">
    <select id="disc-status" onchange="loadDiscovery()" style="width:150px">
      <option value="">All statuses</option>
      <option value="watching">Watching</option><option value="outreach-ready">Outreach Ready</option>
      <option value="contacted">Contacted</option><option value="not-a-fit">Not a Fit</option>
    </select>
    <button class="btn btn-ghost btn-sm" onclick="syncDiscovery()" title="Import discovery folders from Drive">â†» Sync from Drive</button>
    <button class="btn btn-dark btn-sm" onclick="openNewProspect()">+ New Target</button>
  </div>
  <div id="discovery-grid" class="card-grid"></div>
</div>
<div id="v-prospect-file" class="view">
  <button class="back-btn" onclick="showView('discovery')">â† Discovery</button>
  <div id="pf-body"></div>
</div>
<div id="v-research" class="view">
  <div class="ph"><h1>Research <em>library</em></h1><p>Every block â€” poses, memes, SFX, articles, notes. One place.</p></div>
  
  <!-- Research Tabs -->
  <div style="display:flex; gap:15px; padding:0 20px 15px; border-bottom:2px solid #ddd">
    <button id="tab-library" class="research-tab active">ğŸ“š Library</button>
  </div>
  
  <!-- Library Tab -->
  <div id="research-library-content" class="research-tab-content">
    <div class="tb">
      <input type="text" id="res-search" placeholder="Search blocks..." oninput="debouncedLoad('loadResearch')">
      <select id="res-type" onchange="loadResearch()" style="width:150px">
        <option value="">All types</option>
        <option value="pose">Pose</option><option value="meme">Meme</option>
        <option value="sfx">SFX / Audio</option><option value="image">Image</option>
        <option value="url">URL / Article</option><option value="conversation">Conversation</option>
        <option value="note">Note</option><option value="pdf">PDF</option>
      </select>
      <select id="res-funnel" onchange="loadResearch()" style="width:130px">
        <option value="" selected>All stages</option>
        <option value="tof">TOF</option><option value="mof">MOF</option><option value="bof">BOF</option>
      </select>
      <button class="btn btn-dark btn-sm" onclick="openAddBlock()">+ Add Block</button>
      <button class="btn btn-ghost btn-sm" id="sync-btn" onclick="syncDrive()" title="Scan all Drive folders and import any new files">â†» Sync Drive</button>
      <button class="btn btn-ghost btn-sm" id="cleanup-btn" onclick="cleanupDeleted()" title="Remove files that were deleted from Drive">ğŸ—‘ï¸ Clean Up</button>
      <button class="btn btn-ghost btn-sm" id="repair-btn" onclick="repairThumbnails()" title="Fix broken thumbnails on existing blocks">ğŸ”§ Fix Thumbs</button>
    </div>
    <div id="research-grid" class="block-grid"></div>
  </div>
</div>
<div id="v-calendar" class="view">
  <div class="ph"><h1>Content <em>calendar</em></h1><p>Idea to posted â€” assemble posts from your research blocks.</p></div>
  <div class="tb">
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-dark btn-sm" id="view-toggle-kanban" onclick="toggleCalendarView('kanban')">ğŸ“Š Kanban</button>
      <button class="btn btn-ghost btn-sm" id="view-toggle-month" onclick="toggleCalendarView('month')">ğŸ“… Month</button>
    </div>
    <div style="display:flex;gap:8px">
      <select id="cal-plat" onchange="loadCalendar()" style="width:140px">
        <option value="">All platforms</option>
        <option>Instagram</option><option>TikTok</option><option>LinkedIn</option>
      </select>
      <button class="btn btn-dark btn-sm" onclick="openNewPost()">+ New Post</button>
    </div>
  </div>
  
  <!-- Kanban View -->
  <div id="kanban-view" class="kanban">
    <div class="kcol"><div class="kcol-head">ğŸ’¡ Idea</div><div id="k-idea"></div></div>
    <div class="kcol"><div class="kcol-head">âœï¸ Draft</div><div id="k-draft"></div></div>
    <div class="kcol"><div class="kcol-head">âœ… Ready</div><div id="k-ready"></div></div>
    <div class="kcol"><div class="kcol-head">ğŸš€ Posted</div><div id="k-posted"></div></div>
  </div>
  
  <!-- Month View -->
  <div id="month-view" style="display:none">
    <div class="month-nav">
      <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">â†</button>
      <h2 id="month-title" style="font-size:18px;font-weight:700;margin:0"></h2>
      <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">â†’</button>
    </div>
    <div class="month-grid" id="month-grid"></div>
  </div>
</div>
<div id="v-post-builder" class="view">
  <button class="back-btn" onclick="showView('calendar')">â† Calendar</button>
  <div id="pb-body"></div>
</div>
</div>
<!-- MODALS -->
<div class="mbg off" id="m-client"><div class="modal">
  <div class="mh"><h2>New Client</h2><button class="mx" onclick="closeM('m-client')">âœ•</button></div>
  <div class="mb">
    <div class="g2">
      <div><label>Name *</label><input id="mc-name"></div>
      <div><label>Platform</label>
        <select id="mc-platform"><option>Instagram</option><option>Facebook</option><option>Referral</option><option>Website</option><option>Other</option></select>
      </div>
    </div>
    <div class="g2">
      <div><label>Session Type</label>
        <select id="mc-stype"><option>Professional Headshots</option><option>Personal / Confidence</option><option>Family / Legacy</option><option>Graduate</option><option>Creative</option></select>
      </div>
      <div><label>Session Date</label><input id="mc-date" placeholder="e.g. March 8"></div>
    </div>
    <div class="g2">
      <div><label>Offer / Package</label><input id="mc-offer" placeholder="e.g. Signature $175"></div>
      <div><label>Status</label>
        <select id="mc-status"><option value="lead">Lead</option><option value="booked">Booked</option><option value="shot">Shot</option><option value="delivered">Delivered</option></select>
      </div>
    </div>
    <label>First Contact</label><input id="mc-contact" placeholder="e.g. March 1">
    <div style="margin-top:18px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeM('m-client')">Cancel</button>
      <button class="btn btn-dark" onclick="saveClient()">Create Client File â†’</button>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-prospect"><div class="modal">
  <div class="mh"><h2>New Discovery Target</h2><button class="mx" onclick="closeM('m-prospect')">âœ•</button></div>
  <div class="mb">
    <div class="g2">
      <div><label>Name / Brand *</label><input id="mp-name"></div>
      <div><label>Handle</label><input id="mp-handle" placeholder="@handle"></div>
    </div>
    <div class="g2">
      <div><label>Platform</label>
        <select id="mp-platform"><option>Instagram</option><option>TikTok</option><option>LinkedIn</option><option>Facebook</option></select>
      </div>
      <div><label>Category</label>
        <select id="mp-category"><option value="">â€” select â€”</option><option value="founder">Founder</option><option value="artist">Artist / Creator</option><option value="realtor">Realtor</option><option value="fitness">Fitness</option><option value="brand">Local Brand</option><option value="professional">Professional</option><option value="collab">Collab Idea</option></select>
      </div>
    </div>
    <label>Why them?</label>
    <textarea id="mp-why" placeholder="What makes this person worth reaching out to?"></textarea>
    <div style="margin-top:18px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeM('m-prospect')">Cancel</button>
      <button class="btn btn-dark" onclick="saveProspect()">Add to Discovery â†’</button>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-addblock"><div class="modal">
  <div class="mh"><h2>Add Block</h2><button class="mx" onclick="closeM('m-addblock')">âœ•</button></div>
  <div class="mb">
    <div class="tabs">
      <button class="tab on" onclick="switchTab('abt','url',this)">ğŸ”— URL</button>
      <button class="tab" onclick="switchTab('abt','upload',this)">ğŸ“ Upload</button>
      <button class="tab" onclick="switchTab('abt','drive',this)">â˜ï¸ Drive</button>
      <button class="tab" onclick="switchTab('abt','text',this)">âœï¸ Text</button>
    </div>
    <div id="abt-url" class="tc on">
      <label>URL *</label><input id="ab-url" type="url" placeholder="https://..." oninput="checkVideoUrl()">
      <div id="ab-url-video-hint" style="display:none;background:#1a1a0e;border:1px solid #333;border-radius:8px;padding:12px 14px;margin-bottom:10px">
        <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:3px">ğŸ¬ Video detected</div>
        <div style="font-size:11px;color:#888;line-height:1.5">Downloads the video, captures frames, transcribes with Whisper, summarizes key points. Takes 30â€“90 seconds.</div>
        <div style="font-size:11px;color:#aaa;margin-top:6px;line-height:1.6">
          âœ“ TikTok &nbsp;Â·&nbsp; âœ“ YouTube &nbsp;Â·&nbsp; âœ“ Instagram <span style="color:#666">(needs cookie setup below)</span>
        </div>
        <details style="margin-top:8px">
          <summary style="font-size:10px;color:#666;cursor:pointer;user-select:none">Instagram setup (one time)</summary>
          <div style="font-size:10px;color:#777;line-height:1.8;margin-top:6px;padding:8px;background:#111;border-radius:6px">
            1. Install <strong style="color:#aaa">Cookie-Editor</strong> extension in Chrome<br>
            2. Go to instagram.com and log in<br>
            3. Click Cookie-Editor â†’ <strong style="color:#aaa">Export â†’ Export as Netscape</strong><br>
            4. Copy the entire text output<br>
            5. In Railway â†’ your service â†’ Variables â†’ add <code style="background:#222;padding:1px 4px;border-radius:3px">INSTAGRAM_COOKIES</code> â†’ paste as value<br>
            6. Redeploy<br>
            <span style="color:#555;margin-top:4px;display:block">Cookies expire every few months â€” you'll get a clear error when it's time to refresh.</span>
          </div>
        </details>
      </div>
      <div class="g2">
        <div><label>Type</label><select id="ab-url-type" onchange="checkVideoUrl()"><option value="url">Article / Link</option><option value="video">ğŸ¬ TikTok / Reel / Video</option><option value="image">Image</option></select></div>
        <div><label>Category</label><input id="ab-url-cat" placeholder="e.g. marketing, posing"></div>
      </div>
      <div class="g2">
        <div><label>Funnel Stage</label><select id="ab-url-funnel"><option value="">â€”</option><option value="tof">TOF</option><option value="mof">MOF</option><option value="bof">BOF</option></select></div>
        <div><label>Tags</label><input id="ab-url-tags" placeholder="comma separated"></div>
      </div>
      <div id="ab-url-progress" style="display:none;margin:14px 0">
        <div class="progress-card">
          <div class="progress-spinner"></div>
          <div class="progress-step"><strong id="ab-prog-step">Starting...</strong><span id="ab-prog-msg"></span></div>
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end" id="ab-url-actions">
        <button class="btn btn-ghost" onclick="closeM('m-addblock')">Cancel</button>
        <button class="btn btn-dark" id="ab-url-btn" onclick="handleUrlIngest()">Save Block â†’</button>
      </div>
    </div>
    <div id="abt-upload" class="tc">
      <div style="border:2px dashed var(--border);border-radius:var(--r);padding:20px;text-align:center;color:var(--muted);cursor:pointer" onclick="document.getElementById('ab-file').click()">
        <div style="font-size:28px;margin-bottom:5px">ğŸ“</div>
        <p style="font-size:13px">Drop file or <span style="color:var(--accent)">browse</span></p>
        <input type="file" id="ab-file" style="display:none" onchange="handleAbFile(this)">
      </div>
      <div id="ab-file-info" style="font-size:12px;color:var(--muted);margin:6px 0;display:none"></div>
      <div class="g3">
        <div><label>Type</label><select id="ab-up-type"><option value="image">Image</option><option value="video">Video</option><option value="meme">Meme</option><option value="pose">Pose</option><option value="sfx">SFX</option><option value="pdf">PDF</option></select></div>
        <div><label>Category</label><input id="ab-up-cat"></div>
        <div><label>Funnel</label><select id="ab-up-funnel"><option value="">â€”</option><option value="tof">TOF</option><option value="mof">MOF</option><option value="bof">BOF</option></select></div>
      </div>
      <label>Title</label><input id="ab-up-title">
      <label>Tags</label><input id="ab-up-tags" placeholder="comma separated">
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeM('m-addblock')">Cancel</button>
        <button class="btn btn-dark" id="ab-up-btn" onclick="uploadBlock()">Upload â†’</button>
      </div>
    </div>
    <div id="abt-drive" class="tc">
      <div style="background:#f5f4f0;border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:11px;color:var(--muted);line-height:1.6">
        <strong style="color:var(--text);font-size:11px">Your Drive folder structure:</strong><br>
        <code style="font-size:10px;letter-spacing:.3px">My Drive / Pose</code> â†’ poses &nbsp;Â·&nbsp;
        <code style="font-size:10px">My Drive / Meme</code> â†’ memes &nbsp;Â·&nbsp;
        <code style="font-size:10px">My Drive / SFX</code> â†’ audio &nbsp;Â·&nbsp;
        <code style="font-size:10px">My Drive / Music</code> â†’ music<br>
        <code style="font-size:10px">My Drive / Phixo Knowledge</code> â†’ PDFs/docs &nbsp;Â·&nbsp;
        <code style="font-size:10px">My Drive / Tik Tok Scripts</code> â†’ scripts
      </div>
      <div class="g2" style="margin-bottom:8px">
        <div><label>Folder to browse</label>
          <select id="ab-drive-folder" onchange="loadDriveFolder()">
            <option value="Pose">Pose</option>
            <option value="Meme">Meme</option>
            <option value="SFX">SFX</option>
            <option value="Music">Music</option>
            <option value="Phixo Knowledge">Phixo Knowledge</option>
            <option value="Tik Tok Scripts">Tik Tok Scripts</option>
          </select>
        </div>
        <div><label>Block type to assign</label>
          <select id="ab-drive-type" onchange="syncDriveType()">
            <option value="pose">Pose</option>
            <option value="meme">Meme</option>
            <option value="sfx">SFX / Audio</option>
            <option value="image">Image</option>
            <option value="pdf">PDF</option>
          </select>
        </div>
      </div>
      <div class="g2" style="margin-bottom:8px">
        <div><label>Category (optional)</label><input id="ab-drive-cat" placeholder="auto-fills from folder"></div>
        <div><label>Tags</label><input id="ab-drive-tags" placeholder="comma separated"></div>
      </div>
      <div id="ab-drive-grid" class="drive-grid" style="margin-bottom:10px;min-height:80px">
        <div style="font-size:12px;color:var(--muted);padding:8px;grid-column:1/-1">Loading...</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center">
        <span id="ab-drive-count" style="font-size:12px;color:var(--muted);margin-right:auto">0 selected</span>
        <button class="btn btn-ghost" onclick="closeM('m-addblock')">Cancel</button>
        <button class="btn btn-dark" id="ab-drive-btn" onclick="saveBlocksFromDrive()" disabled>Add Selected â†’</button>
      </div>
    </div>
    <div id="abt-text" class="tc">
      <div class="g2">
        <div><label>Type</label><select id="ab-txt-type"><option value="note">Note</option><option value="conversation">Conversation</option><option value="transcript">Transcript</option></select></div>
        <div><label>Category</label><input id="ab-txt-cat"></div>
      </div>
      <label>Title</label><input id="ab-txt-title">
      <label>Content *</label><textarea id="ab-txt-content" style="min-height:120px"></textarea>
      <div class="g2">
        <div><label>Funnel</label><select id="ab-txt-funnel"><option value="">â€”</option><option value="tof">TOF</option><option value="mof">MOF</option><option value="bof">BOF</option></select></div>
        <div><label>Tags</label><input id="ab-txt-tags" placeholder="comma separated"></div>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeM('m-addblock')">Cancel</button>
        <button class="btn btn-dark" onclick="saveTextBlock()">Save Block â†’</button>
      </div>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-block-detail"><div class="modal">
  <div class="mh"><h2 id="bd-title">Block</h2><button class="mx" onclick="closeM('m-block-detail')">âœ•</button></div>
  <div class="mb" id="bd-body"></div>
</div></div>

<div class="mbg off" id="m-block-picker"><div class="modal wide">
  <div class="mh"><h2 id="bkp-title">Pick Blocks</h2><button class="mx" onclick="closeM('m-block-picker')">âœ•</button></div>
  <div class="mb">
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <input type="text" id="bkp-search" placeholder="Search..." oninput="loadPickerBlocks()" style="flex:1">
      <select id="bkp-type" onchange="loadPickerBlocks()" style="width:140px">
        <option value="">All types</option>
        <option value="pose">Pose</option><option value="meme">Meme</option>
        <option value="sfx">SFX</option><option value="image">Image</option>
        <option value="url">URL</option><option value="note">Note</option>
        <option value="conversation">Conversation</option>
      </select>
      <span id="bkp-sel-count" style="font-size:12px;color:var(--muted);align-self:center">0 selected</span>
    </div>
    <div id="bkp-grid" class="bpm-grid"></div>
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeM('m-block-picker')">Cancel</button>
      <button class="btn btn-dark" id="bkp-attach" onclick="confirmPickerAttach()" disabled>Attach â†’</button>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-analyze"><div class="modal">
  <div class="mh"><h2>Analyze Conversation</h2><button class="mx" onclick="closeM('m-analyze')">âœ•</button></div>
  <div class="mb">
    <div class="tabs">
      <button class="tab on" onclick="switchTab('az','text',this)">Paste Text</button>
      <button class="tab" onclick="switchTab('az','img',this)">Screenshot</button>
    </div>
    <div id="az-text" class="tc on">
      <label>Full DM conversation</label>
      <textarea id="az-conv" style="min-height:200px" placeholder="Paste the entire thread..."></textarea>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeM('m-analyze')">Cancel</button>
        <button class="btn btn-dark" id="az-btn" onclick="analyzeConversation()">Analyze with Claude â†’</button>
      </div>
    </div>
    <div id="az-img" class="tc">
      <div style="border:2px dashed var(--border);border-radius:var(--r);padding:24px;text-align:center;color:var(--muted);cursor:pointer" onclick="document.getElementById('az-file').click()">
        <div style="font-size:28px;margin-bottom:5px">ğŸ“·</div>
        <p style="font-size:13px">Drop screenshot or <span style="color:var(--accent)">browse</span></p>
        <input type="file" id="az-file" accept="image/*" style="display:none" onchange="handleAzFile(this)">
      </div>
      <div id="az-preview" style="display:none;margin:10px 0"><img id="az-img-prev" style="max-width:100%;border-radius:8px;max-height:160px;object-fit:contain"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeM('m-analyze')">Cancel</button>
        <button class="btn btn-dark" id="az-img-btn" onclick="analyzeImage()">Analyze Screenshot â†’</button>
      </div>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-editfield"><div class="modal" style="max-width:440px">
  <div class="mh"><h2 id="ef-label">Edit</h2><button class="mx" onclick="closeM('m-editfield')">âœ•</button></div>
  <div class="mb">
    <textarea id="ef-val" style="min-height:100px"></textarea>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeM('m-editfield')">Cancel</button>
      <button class="btn btn-dark" onclick="confirmEditField()">Save</button>
    </div>
  </div>
</div></div>

<div class="mbg off" id="m-hooks"><div class="modal">
  <div class="mh"><h2>Hook Library</h2><button class="mx" onclick="closeM('m-hooks')">âœ•</button></div>
  <div class="mb">
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input type="text" id="hook-search" placeholder="Search hooks..." oninput="loadHooks()" style="flex:1">
      <select id="hook-cat" onchange="loadHooks()" style="width:140px">
        <option value="">All categories</option>
        <option value="story">Story</option><option value="contrarian">Contrarian</option>
        <option value="mistake">Mistake</option><option value="educational">Educational</option>
        <option value="curiosity">Curiosity</option><option value="if-then">If-Then</option>
        <option value="before-after">Before/After</option><option value="question">Question</option>
        <option value="number-list">Number List</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="ingestHooksPdf()" id="hooks-ingest-btn">â†» PDF</button>
    </div>
    <div id="hooks-list" style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px"></div>
    <div style="margin-top:10px;display:flex;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeM('m-hooks')">Close</button>
    </div>
  </div>
</div></div>

<div class="toast" id="toast"></div>
<script>
// â•â•â• STATE â•â•â•
let CID=null,PROID=null,POST_ID=null,ef_key=null,ef_entity=null;
let ab_file=null,az_file=null,driveFiles=[];
let ab_driveSelIds=new Set(),picker_sel=new Set();
let pickerEntity=null,pickerEntityId=null;
let assistHistory=[],postModules=[],allBlocks=[];
let dragSrcIdx=null;

// â•â•â• UTILS â•â•â•
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast on '+type;
  clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('on'),2800);
}
const dtimers={};
function debouncedLoad(fn){clearTimeout(dtimers[fn]);dtimers[fn]=setTimeout(()=>window[fn](),280);}

async function api(method,url,body){
  const opts={method,headers:{}};
  if(body instanceof FormData){opts.body=body;}
  else if(body){opts.headers['Content-Type']='application/json';opts.body=JSON.stringify(body);}
  const r=await fetch(url,opts);
  if(!r.ok){const e=await r.json().catch(()=>({error:'Failed'}));throw new Error(e.error||'Failed');}
  return r.json();
}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function typeIcon(t){return{pose:'ğŸ§',meme:'ğŸ˜‚',sfx:'ğŸµ',audio:'ğŸµ',image:'ğŸ–¼ï¸',url:'ğŸ“„',video:'ğŸ¬',conversation:'ğŸ’¬',note:'ğŸ“',pdf:'ğŸ“‹',transcript:'ğŸ“'}[t]||'ğŸ“';}
function funnelBadge(f){if(!f)return'';const l={tof:'TOF',mof:'MOF',bof:'BOF'};return`<span class="funnel-label fl-${f}">${l[f]||f}</span>`;}
function statusClass(s){return{lead:'t-lead',booked:'t-booked',shot:'t-shot',delivered:'t-delivered',watching:'t-watching','outreach-ready':'t-outreach',contacted:'t-contacted','not-a-fit':'t-notfit'}[s]||'t-lead';}
function tempClass(t){if(!t)return't-lead';const l=t.toLowerCase();return l.startsWith('hot')?'t-hot':l.startsWith('warm')?'t-warm':l.startsWith('cold')?'t-cold':'t-lead';}

function showView(name,navEl){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  const v=document.getElementById('v-'+name);
  if(v)v.classList.add('on');
  if(navEl)navEl.classList.add('on');
  else{const nb=document.querySelector(`.nb[data-view="${name}"]`);if(nb)nb.classList.add('on');}
  if(name==='pipeline')loadPipeline();
  else if(name==='research')loadResearch();
  else if(name==='discovery')loadDiscovery();
  else if(name==='calendar')loadCalendar();
}

// â”€â”€ Ask Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAskLibrary(){
  document.getElementById('ask-input').value='';
  openModal('m-ask-library');
  setTimeout(()=>document.getElementById('ask-input').focus(),100);
}

async function askLibrary(){
  const q = document.getElementById('ask-input').value.trim();
  if(!q) return;
  const btn = document.getElementById('ask-btn');
  const status = document.getElementById('ask-status');
  const history = document.getElementById('ask-history');
  btn.disabled=true; btn.textContent='Thinking...';
  status.style.display='block'; status.textContent='Reading your library...';
  history.style.display='flex';

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.style.cssText='align-self:flex-end;background:var(--accent);color:#fff;border-radius:12px 12px 2px 12px;padding:10px 14px;font-size:13px;max-width:85%;line-height:1.6';
  userMsg.textContent=q;
  history.appendChild(userMsg);
  history.scrollTop=history.scrollHeight;
  document.getElementById('ask-input').value='';

  try {
    const r = await api('POST','/api/library/ask',{question:q});
    
    // Add AI answer
    const aiMsg = document.createElement('div');
    aiMsg.style.cssText='align-self:flex-start;background:var(--surface-2);border-radius:2px 12px 12px 12px;padding:12px 14px;font-size:13px;max-width:90%;line-height:1.7;white-space:pre-wrap;border:1px solid var(--border)';
    aiMsg.textContent=r.answer;

    if(r.sources && r.sources.length){
      const srcs = document.createElement('div');
      srcs.style.cssText='margin-top:10px;padding-top:8px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:6px';
      srcs.innerHTML='<span style="font-size:10px;color:var(--muted);width:100%;font-weight:600;letter-spacing:.4px;text-transform:uppercase">Sources</span>' +
        r.sources.map(s=>`<button onclick="openBlockDetail(${s.id});closeM('m-ask-library')" style="background:var(--surface-3);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;color:var(--text)">${esc(s.title)}</button>`).join('');
      aiMsg.appendChild(srcs);
    }

    const meta = document.createElement('div');
    meta.style.cssText='font-size:10px;color:var(--muted);margin-top:6px';
    meta.textContent=`â†‘ Based on ${r.block_count} blocks in your library`;
    aiMsg.appendChild(meta);

    history.appendChild(aiMsg);
    history.scrollTop=history.scrollHeight;
    status.style.display='none';
  } catch(err){
    toast(err.message,'err');
    status.style.display='none';
  }
  btn.disabled=false; btn.textContent='Ask â†’';
}
function closeM(id){document.getElementById(id).classList.add('off');}
function openModal(id){document.getElementById(id).classList.remove('off');}
function switchTab(group,tab,btn){
  const modal=btn.closest('.modal,.mbg');
  modal.querySelectorAll('.tc').forEach(c=>c.classList.remove('on'));
  const tc=document.getElementById(group+'-'+tab);
  if(tc)tc.classList.add('on');
  btn.closest('.tabs').querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
}
document.querySelectorAll('.mbg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.add('off');}));

// â•â•â• PIPELINE â•â•â•
async function loadPipeline(){
  const p=new URLSearchParams();
  const s=document.getElementById('pl-search').value;
  const st=document.getElementById('pl-status').value;
  if(s)p.set('search',s);if(st)p.set('status',st);
  const clients=await api('GET','/api/clients?'+p);
  const grid=document.getElementById('pipeline-grid');
  if(!clients.length){grid.innerHTML='<div class="empty"><div class="ei">ğŸ‘¤</div><p>No clients yet</p></div>';return;}
  grid.innerHTML=clients.map(c=>`
    <div class="card" onclick="openClientFile(${c.id})">
      <h3>${esc(c.name)}</h3>
      <div class="meta">${esc(c.platform||'')}${c.session_type?` Â· ${esc(c.session_type)}`:''}${c.session_date?` Â· ${esc(c.session_date)}`:''}</div>
      <div class="foot">
        <span class="tag ${statusClass(c.status)}">${c.status}</span>
        ${c.lead_temperature?`<span class="tag ${tempClass(c.lead_temperature)}">${esc(c.lead_temperature.split(' ')[0])}</span>`:''}
        <span style="margin-left:auto;font-size:11px;color:var(--muted)">${new Date(c.updated_at).toLocaleDateString('en-CA')}</span>
      </div>
    </div>`).join('');
}
function openNewClient(){
  ['mc-name','mc-date','mc-offer','mc-contact'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mc-status').value='lead';
  openModal('m-client');
}
async function saveClient(){
  const name=document.getElementById('mc-name').value.trim();
  if(!name){toast('Name required','err');return;}
  try{
    const c=await api('POST','/api/clients',{
      name,platform:document.getElementById('mc-platform').value,
      session_type:document.getElementById('mc-stype').value,
      session_date:document.getElementById('mc-date').value,
      offer:document.getElementById('mc-offer').value,
      first_contact:document.getElementById('mc-contact').value,
      status:document.getElementById('mc-status').value
    });
    closeM('m-client');toast('Client created','ok');openClientFile(c.id);
  }catch(err){toast(err.message,'err');}
}

// â•â•â• CLIENT FILE â•â•â•
async function openClientFile(id){
  CID=id;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.getElementById('v-client-file').classList.add('on');
  const c=await api('GET','/api/clients/'+id);
  renderClientFile(c);
}
function renderClientFile(c){
  const metaParts=[c.platform,c.session_type,c.session_date].filter(Boolean);
  const poses=(c.blocks||[]).filter(b=>b.type==='pose');
  const otherBlocks=(c.blocks||[]).filter(b=>b.type!=='pose');
  function row(label,key,val){
    return `<div class="cf-row"><div class="cf-key">${label}</div><div>
      ${val
        ?`<span class="cf-val editable" onclick="editField('${key}','${esc(val)}','${label}','client')">${esc(val)}</span>`
        :`<span class="cf-val editable empty" onclick="editField('${key}','','${label}','client')">â€” click to add</span>`
      }</div></div>`;
  }
  document.getElementById('cf-body').innerHTML=`
    <div class="cf-header">
      <div class="cf-brand">Phixo â€” Client File</div>
      <div class="cf-name">${esc(c.name)}</div>
      <div class="cf-meta">${metaParts.map(esc).join('  |  ')}</div>
    </div>
    <div class="cf-actions">
      <button class="btn btn-dark btn-sm" onclick="openAnalyze()">ğŸ“‹ Analyze Conversation</button>
      <button class="btn btn-ghost btn-sm" onclick="openBlockPicker('client',${c.id},['pose'],'Add Poses')">ğŸ§ Add Poses</button>
      <button class="btn btn-ghost btn-sm" onclick="openBlockPicker('client',${c.id},null,'Attach Blocks')">ï¼‹ Attach</button>
      <select onchange="updateClientStatus(this.value)" style="padding:5px 10px;font-size:12px;border-radius:7px;border:1px solid var(--border);background:var(--bg)">
        <option value="lead" ${c.status==='lead'?'selected':''}>Lead</option>
        <option value="booked" ${c.status==='booked'?'selected':''}>Booked</option>
        <option value="shot" ${c.status==='shot'?'selected':''}>Shot</option>
        <option value="delivered" ${c.status==='delivered'?'selected':''}>Delivered</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="deleteClient(${c.id})">Delete</button>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Client Info</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd">${row('Name','name',c.name)}${row('Platform','platform',c.platform)}${row('Session Type','session_type',c.session_type)}${row('Session Date','session_date',c.session_date)}${row('Offer','offer',c.offer)}${row('First Contact','first_contact',c.first_contact)}</div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Message Analysis</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd">
        <div class="cf-row"><div class="cf-key">Lead Temperature</div><div>
          ${c.lead_temperature
            ?`<span class="temp-badge ${tempClass(c.lead_temperature)}">${esc(c.lead_temperature)}</span>`
            :`<span class="cf-val editable empty" onclick="editField('lead_temperature','','Lead Temperature','client')">â€” click to add</span>`}
        </div></div>
        ${row('What They Want','what_they_want',c.what_they_want)}
        ${row('Emotional Read','emotional_read',c.emotional_read)}
        ${row('Red Flags','red_flags',c.red_flags)}
        ${row('Opportunity','opportunity',c.opportunity)}
      </div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Session Briefing â€” How to Connect with ${esc(c.name)}</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd">
        ${row('How to Open','how_to_open',c.how_to_open)}
        ${row('Things to Avoid','things_to_avoid',c.things_to_avoid)}
        ${row('Key Question','key_question',c.key_question)}
        ${row('Talk About','things_to_talk_about',c.things_to_talk_about)}
        ${row('What They Need','what_they_need',c.what_they_need)}
        ${row('Watch For','moment_to_watch',c.moment_to_watch)}
        ${row('How to Close','how_to_close',c.how_to_close)}
        ${row('Lighting Setup','lighting_setup',c.lighting_setup)}
      </div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Pose Selection</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd" style="padding-top:12px">
        <div class="pose-grid">
          ${poses.map(p=>`
            <div class="pose-tile" onclick="openLightbox('${p.drive_file_id?`/api/drive/file/${p.drive_file_id}`:esc(p.thumbnail_url||'')}','${esc(p.file_name||p.title)}')" title="${esc(p.file_name||p.title)}">
              <img src="${p.thumbnail_url?esc(p.thumbnail_url):`/api/drive/file/${p.drive_file_id}`}" loading="lazy" onerror="this.src='/api/drive/file/${p.drive_file_id}';this.onerror=null">
              <button class="rm" onclick="event.stopPropagation();detachBlock(${p.attachment_id},'client')">âœ•</button>
            </div>`).join('')}
          <button class="pose-tile-add" onclick="openBlockPicker('client',${c.id},['pose'],'Add Poses')">
            <span style="font-size:28px">ï¼‹</span><span>Add Pose</span>
          </button>
        </div>
      </div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Attached Blocks</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd" style="padding-top:12px">
        <div class="block-strip">
          ${otherBlocks.map(b=>`
            <div class="strip-thumb" title="${esc(b.title)}" style="cursor:pointer" onclick="openBlockDetail(${b.id})">
              ${b.drive_file_id&&b.file_mime&&b.file_mime.startsWith('image/')
                ?`<img src="/api/drive/file/${b.drive_file_id}" loading="lazy">`
                :`<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:24px">${typeIcon(b.type)}</div>`}
              <button class="rm" onclick="event.stopPropagation();detachBlock(${b.attachment_id},'client')">âœ•</button>
            </div>`).join('')}
          <button class="strip-add" onclick="openBlockPicker('client',${c.id},null,'Attach Blocks')">
            <span class="ico">ï¼‹</span><span>Attach</span>
          </button>
        </div>
      </div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Conversation Log</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd" style="padding-top:12px">
        ${c.conversation_log
          ?`<div class="conv-block">${esc(c.conversation_log)}</div>`
          :`<p style="font-size:13px;color:var(--muted)">No conversation yet â€” use Analyze Conversation above.</p>`}
      </div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Draft Reply / Final Sent</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd" style="padding-top:12px">
        ${c.draft_reply
          ?`<div class="draft-block">${esc(c.draft_reply)}</div><div style="margin-top:8px">${row('Final Version Sent','final_reply',c.final_reply)}</div>`
          :row('Draft / Final Reply','draft_reply',c.draft_reply)}
      </div>
    </div>
    <div style="font-size:11px;color:var(--muted);text-align:right;margin-top:12px">
      Last updated: ${new Date(c.updated_at).toLocaleString('en-CA')} | Phixo Studio â€” West Island Montreal
    </div>`;
}
function toggleSec(h){
  const body=h.nextElementSibling;
  body.classList.toggle('hide');
  h.classList.toggle('open',!body.classList.contains('hide'));
  h.querySelector('.arr').textContent=body.classList.contains('hide')?'â–¸':'â–¾';
}
function editField(key,current,label,entity){
  ef_key=key;ef_entity=entity;
  document.getElementById('ef-label').textContent='Edit: '+label;
  document.getElementById('ef-val').value=current;
  openModal('m-editfield');
  setTimeout(()=>document.getElementById('ef-val').focus(),60);
}
async function confirmEditField(){
  const val=document.getElementById('ef-val').value;
  try{
    if(ef_entity==='client'){const c=await api('PATCH','/api/clients/'+CID,{[ef_key]:val});closeM('m-editfield');toast('Saved','ok');renderClientFile(c);}
    else if(ef_entity==='prospect'){const p=await api('PATCH','/api/prospects/'+PROID,{[ef_key]:val});closeM('m-editfield');toast('Saved','ok');renderProspectFile(p);}
  }catch(err){toast(err.message,'err');}
}
async function updateClientStatus(s){
  try{await api('PATCH','/api/clients/'+CID,{status:s});toast('Updated','ok');}
  catch(err){toast(err.message,'err');}
}
async function deleteClient(id){
  if(!confirm('Delete this client file?'))return;
  try{await api('DELETE','/api/clients/'+id);toast('Deleted');showView('pipeline');}
  catch(err){toast(err.message,'err');}
}

// â•â•â• ANALYZE â•â•â•
function openAnalyze(){
  document.getElementById('az-conv').value='';az_file=null;
  document.getElementById('az-preview').style.display='none';
  openModal('m-analyze');
}
async function analyzeConversation(){
  const conv=document.getElementById('az-conv').value.trim();
  if(!conv){toast('Paste a conversation','err');return;}
  const btn=document.getElementById('az-btn');
  btn.disabled=true;btn.textContent='Analyzing...';
  try{
    const r=await api('POST','/api/clients/'+CID+'/analyze',{conversation:conv});
    closeM('m-analyze');toast('Analysis complete','ok');renderClientFile(r.client);
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Analyze with Claude â†’';}
}
function handleAzFile(input){
  az_file=input.files[0];
  if(az_file){const r=new FileReader();r.onload=e=>{document.getElementById('az-img-prev').src=e.target.result;document.getElementById('az-preview').style.display='block';};r.readAsDataURL(az_file);}
}
async function analyzeImage(){
  if(!az_file){toast('Select a screenshot','err');return;}
  const btn=document.getElementById('az-img-btn');
  btn.disabled=true;btn.textContent='Analyzing...';
  try{
    const fd=new FormData();fd.append('screenshot',az_file);
    const res=await fetch('/api/clients/'+CID+'/analyze-image',{method:'POST',body:fd});
    if(!res.ok)throw new Error((await res.json()).error);
    const r=await res.json();
    closeM('m-analyze');toast('Screenshot analyzed','ok');renderClientFile(r.client);
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Analyze Screenshot â†’';}
}

// â•â•â• DISCOVERY â•â•â•
async function loadDiscovery(){
  const p=new URLSearchParams();
  const s=document.getElementById('disc-search').value;
  const st=document.getElementById('disc-status').value;
  if(s)p.set('search',s);if(st)p.set('status',st);
  const prospects=await api('GET','/api/prospects?'+p);
  const grid=document.getElementById('discovery-grid');
  if(!prospects.length){grid.innerHTML='<div class="empty"><div class="ei">ğŸ”­</div><p>No targets yet</p></div>';return;}
  grid.innerHTML=prospects.map(p=>`
    <div class="card" onclick="openProspectFile(${p.id})">
      <h3>${esc(p.name)}${p.handle?` <span style="font-weight:400;color:var(--muted)">@${esc(p.handle)}</span>`:''}</h3>
      <div class="meta">${esc(p.platform||'')}${p.category?` Â· ${esc(p.category)}`:''}</div>
      <div class="foot">
        <span class="tag ${statusClass(p.status)}">${p.status}</span>
        <span style="margin-left:auto;font-size:11px;color:var(--muted)">${new Date(p.created_at).toLocaleDateString('en-CA')}</span>
      </div>
    </div>`).join('');
}
function openNewProspect(){
  ['mp-name','mp-handle','mp-why'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mp-category').value='';
  openModal('m-prospect');
}
async function saveProspect(){
  const name=document.getElementById('mp-name').value.trim();
  if(!name){toast('Name required','err');return;}
  try{
    const p=await api('POST','/api/prospects',{
      name,handle:document.getElementById('mp-handle').value,
      platform:document.getElementById('mp-platform').value,
      category:document.getElementById('mp-category').value,
      why_them:document.getElementById('mp-why').value
    });
    closeM('m-prospect');toast('Added to Discovery','ok');openProspectFile(p.id);
  }catch(err){toast(err.message,'err');}
}
async function openProspectFile(id){
  PROID=id;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.getElementById('v-prospect-file').classList.add('on');
  const p=await api('GET','/api/prospects/'+id);
  renderProspectFile(p);
}
function renderProspectFile(p){
  function row(label,key,val){
    return `<div class="cf-row"><div class="cf-key">${label}</div><div>
      ${val?`<span class="cf-val editable" onclick="editField('${key}','${esc(val)}','${label}','prospect')">${esc(val)}</span>`
           :`<span class="cf-val editable empty" onclick="editField('${key}','','${label}','prospect')">â€” click to add</span>`}
    </div></div>`;
  }
  document.getElementById('pf-body').innerHTML=`
    <div class="cf-header" style="background:#1a1a40">
      <div class="cf-brand">Phixo â€” Discovery Target</div>
      <div class="cf-name">${esc(p.name)}</div>
      <div class="cf-meta">${[p.handle&&('@'+p.handle),p.platform,p.category].filter(Boolean).map(esc).join('  |  ')}</div>
    </div>
    <div class="cf-actions">
      <button class="btn btn-ghost btn-sm" onclick="openBlockPicker('prospect',${p.id},null,'Attach Research')">ï¼‹ Attach Blocks</button>
      <select onchange="updateProspectStatus(this.value)" style="padding:5px 10px;font-size:12px;border-radius:7px;border:1px solid var(--border);background:var(--bg)">
        <option value="watching" ${p.status==='watching'?'selected':''}>Watching</option>
        <option value="outreach-ready" ${p.status==='outreach-ready'?'selected':''}>Outreach Ready</option>
        <option value="contacted" ${p.status==='contacted'?'selected':''}>Contacted</option>
        <option value="not-a-fit" ${p.status==='not-a-fit'?'selected':''}>Not a Fit</option>
      </select>
      <button class="btn btn-accent btn-sm" onclick="convertProspect(${p.id})">â†’ Convert to Client</button>
      <button class="btn btn-danger btn-sm" onclick="deleteProspect(${p.id})">Delete</button>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Target Info</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd">${row('Name','name',p.name)}${row('Handle','handle',p.handle)}${row('Platform','platform',p.platform)}${row('Category','category',p.category)}${row('Why Them','why_them',p.why_them)}${row('Notes','notes',p.notes)}</div>
    </div>
    <div class="cf-sec">
      <div class="cf-sh open" onclick="toggleSec(this)"><h3>Attached Blocks</h3><span class="arr">â–¾</span></div>
      <div class="cf-bd" style="padding-top:12px">
        <div class="block-strip">
          ${(p.blocks||[]).map(b=>`
            <div class="strip-thumb" onclick="openBlockDetail(${b.id})" style="cursor:pointer" title="${esc(b.title)}">
              ${b.drive_file_id&&b.file_mime&&b.file_mime.startsWith('image/')
                ?`<img src="/api/drive/file/${b.drive_file_id}" loading="lazy">`
                :`<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:24px">${typeIcon(b.type)}</div>`}
              <button class="rm" onclick="event.stopPropagation();detachBlock(${b.attachment_id},'prospect')">âœ•</button>
            </div>`).join('')}
          <button class="strip-add" onclick="openBlockPicker('prospect',${p.id},null,'Attach Blocks')">
            <span class="ico">ï¼‹</span><span>Attach</span>
          </button>
        </div>
      </div>
    </div>`;
}
async function updateProspectStatus(s){
  try{await api('PATCH','/api/prospects/'+PROID,{status:s});toast('Updated','ok');}
  catch(err){toast(err.message,'err');}
}
async function convertProspect(id){
  if(!confirm('Convert to Client in Pipeline?'))return;
  try{const r=await api('POST','/api/prospects/'+id+'/convert');toast('Converted','ok');openClientFile(r.client.id);}
  catch(err){toast(err.message,'err');}
}
async function deleteProspect(id){
  if(!confirm('Delete this target?'))return;
  try{await api('DELETE','/api/prospects/'+id);toast('Deleted');showView('discovery');}
  catch(err){toast(err.message,'err');}
}

// â•â•â• RESEARCH â•â•â•
async function loadResearch(){
  const p=new URLSearchParams();
  const s=document.getElementById('res-search').value;
  const t=document.getElementById('res-type').value;
  const f=document.getElementById('res-funnel').value;
  if(s)p.set('search',s);if(t)p.set('type',t);if(f)p.set('funnel_stage',f);
  const blocks=await api('GET','/api/blocks?'+p);
  const grid=document.getElementById('research-grid');
  if(!blocks.length){grid.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ“š</div><p>No blocks yet</p></div>';return;}
  grid.innerHTML=blocks.map(b=>{
    const hasImg=b.drive_file_id&&b.file_mime&&b.file_mime.startsWith('image/');
    const hasVideo=b.type==='video'||(b.drive_file_id&&b.file_mime&&b.file_mime.startsWith('video/'));
    // Images: always proxy (CDN links expire)
    // Everything else: use stored thumbnail_url (proxy path or data: URL)
    // Fallback for images with missing mime: check type name
    let thumbSrc = null;
    if (hasImg && b.drive_file_id) {
      // Images always via file proxy
      thumbSrc = `/api/drive/file/${b.drive_file_id}`;
    } else if (['pose','image'].includes(b.type) && b.drive_file_id) {
      thumbSrc = `/api/drive/file/${b.drive_file_id}`;
    } else if (b.thumbnail_url) {
      // Videos, PDFs, notes â€” use stored proxy URL (thumbnail or screenshot frame)
      thumbSrc = b.thumbnail_url;
    } else if (b.drive_file_id && !hasVideo) {
      // Fallback: request Drive thumbnail on the fly
      thumbSrc = `/api/drive/thumbnail/${b.drive_file_id}`;
    }
    const fallbackIcon = hasVideo ? 'ğŸ¬' : typeIcon(b.type);
    // If stored thumbnail fails and block has drive_file_id, try thumbnail proxy as fallback
    const thumbFallbackSrc = b.drive_file_id ? `/api/drive/thumbnail/${b.drive_file_id}` : null;
    const thumbHtml = thumbSrc
      ? `<img src="${esc(thumbSrc)}" loading="lazy" style="width:100%;height:100%;object-fit:cover" onerror="${thumbFallbackSrc && thumbSrc !== thumbFallbackSrc ? `this.onerror=null;this.src='${thumbFallbackSrc}'` : `this.outerHTML='<span style=\'font-size:36px\'>${fallbackIcon}</span>'`}">`
      : `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:4px"><span style="font-size:36px">${fallbackIcon}</span>${hasVideo ? '<span style="font-size:10px;color:var(--muted)">tap to play</span>' : ''}</div>`;
    return`<div class="block-card" onclick="openBlockDetail(${b.id})">
      <div class="block-thumb">
        ${thumbHtml}
        <span class="type-badge">${b.type}</span>
      </div>
      <div class="block-body">
        ${b.funnel_stage?`<div style="margin-bottom:4px">${funnelBadge(b.funnel_stage)}</div>`:''}
        <div class="block-title">${esc(b.title)}</div>
        ${b.content_payload?`<div class="block-meta">${esc(b.content_payload.substring(0,80))}${b.content_payload.length>80?'â€¦':''}</div>`:''}
        ${b.tags&&b.tags.length?`<div class="block-tags">${b.tags.slice(0,3).map(t=>`<span>${esc(t)}</span>`).join('')}</div>`:''}
      </div>
    </div>`;
  }).join('');
  // Auto-sync on first visit - runs after render
  if(!window._syncedOnce){
    window._syncedOnce=true;
    api('POST','/api/drive/sync').then(r=>{
      if(r.imported>0){toast(r.imported+' new block'+(r.imported!==1?'s':'')+' synced from Drive','ok');loadResearch();}
    }).catch(e=>console.warn('Auto-sync:',e.message));
  }
}
function openAddBlock(defaultTab){
  ['ab-url','ab-url-cat','ab-url-tags','ab-up-title','ab-up-cat','ab-up-tags','ab-txt-title','ab-txt-content','ab-txt-cat','ab-txt-tags','ab-drive-cat','ab-drive-tags'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['ab-url-funnel','ab-up-funnel','ab-txt-funnel'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ab_driveSelIds.clear();ab_file=null;
  document.getElementById('ab-file-info').style.display='none';
  openModal('m-addblock');
  // Auto-switch to Drive tab and load if specified
  if(defaultTab){
    const tabs=document.querySelectorAll('#m-addblock .tab');
    tabs.forEach(t=>t.classList.remove('on'));
    document.querySelectorAll('#m-addblock .tc').forEach(t=>t.classList.remove('on'));
    const tabEl=document.querySelector(`#m-addblock .tab[onclick*="${defaultTab}"]`);
    const tcEl=document.getElementById('abt-'+defaultTab);
    if(tabEl)tabEl.classList.add('on');
    if(tcEl)tcEl.classList.add('on');
  }
  // Always pre-load Drive folder (so it's ready when user switches to that tab)
  loadDriveFolder();
}
async function ingestUrl(){
  const url=document.getElementById('ab-url').value.trim();
  if(!url){toast('URL required','err');return;}
  const btn=document.getElementById('ab-url-btn');btn.disabled=true;btn.textContent='Saving...';
  try{
    await api('POST','/api/blocks/ingest-url',{url,type:document.getElementById('ab-url-type').value,category:document.getElementById('ab-url-cat').value,funnel_stage:document.getElementById('ab-url-funnel').value,tags:document.getElementById('ab-url-tags').value});
    closeM('m-addblock');toast('Block saved','ok');loadResearch();
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Save Block â†’';}
}
function handleAbFile(input){
  ab_file=input.files[0];
  if(ab_file){
    document.getElementById('ab-up-title').value=ab_file.name.replace(/\.[^.]+$/,'');
    document.getElementById('ab-file-info').textContent=ab_file.name+' ('+Math.round(ab_file.size/1024)+' KB)';
    document.getElementById('ab-file-info').style.display='block';
    // Auto-detect type
    const ext = ab_file.name.split('.').pop().toLowerCase();
    const mime = ab_file.type || '';
    const typeEl = document.getElementById('ab-up-type');
    if(mime.startsWith('video/') || ['mp4','mov','webm','mkv'].includes(ext)) typeEl.value='video';
    else if(mime.startsWith('image/') || ['jpg','jpeg','png','gif','webp'].includes(ext)) typeEl.value='image';
    else if(ext==='pdf') typeEl.value='pdf';
  }
}
async function uploadBlock(){
  if(!ab_file){toast('Select a file','err');return;}
  const btn=document.getElementById('ab-up-btn');btn.disabled=true;btn.textContent='Uploading...';
  try{
    const fd=new FormData();fd.append('file',ab_file);fd.append('type',document.getElementById('ab-up-type').value);fd.append('title',document.getElementById('ab-up-title').value||ab_file.name);fd.append('category',document.getElementById('ab-up-cat').value);fd.append('funnel_stage',document.getElementById('ab-up-funnel').value);fd.append('tags',document.getElementById('ab-up-tags').value);
    const res=await fetch('/api/blocks/upload',{method:'POST',body:fd});
    if(!res.ok)throw new Error((await res.json()).error);
    closeM('m-addblock');toast('Uploaded','ok');loadResearch();
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Upload â†’';}
}
async function saveTextBlock(){
  const content=document.getElementById('ab-txt-content').value.trim();
  if(!content){toast('Content required','err');return;}
  try{
    const title=document.getElementById('ab-txt-title').value.trim()||content.substring(0,40);
    await api('POST','/api/blocks',{type:document.getElementById('ab-txt-type').value,title,category:document.getElementById('ab-txt-cat').value,content_payload:content,funnel_stage:document.getElementById('ab-txt-funnel').value,tags:document.getElementById('ab-txt-tags').value.split(',').map(t=>t.trim()).filter(Boolean)});
    closeM('m-addblock');toast('Block saved','ok');loadResearch();
  }catch(err){toast(err.message,'err');}
}
function syncDriveType(){
  // When user changes type, suggest matching category
  const type=document.getElementById('ab-drive-type').value;
  const catEl=document.getElementById('ab-drive-cat');
  if(!catEl.value){
    const cats={pose:'posing',meme:'memes',sfx:'audio',image:'inspiration',pdf:'knowledge'};
    catEl.value=cats[type]||type;
  }
}
async function loadDriveFolder(){
  const folder=document.getElementById('ab-drive-folder').value;
  // Auto-map folder â†’ type and category
  const folderMap={
    'Pose':{type:'pose',cat:'posing'},
    'Meme':{type:'meme',cat:'memes'},
    'SFX':{type:'sfx',cat:'audio'},
    'Music':{type:'sfx',cat:'music'},
    'Phixo Knowledge':{type:'pdf',cat:'knowledge'},
    'Tik Tok Scripts':{type:'note',cat:'scripts'}
  };
  const mapped=folderMap[folder];
  if(mapped){
    document.getElementById('ab-drive-type').value=mapped.type;
    const catEl=document.getElementById('ab-drive-cat');
    if(!catEl.value)catEl.value=mapped.cat;
  }
  const grid=document.getElementById('ab-drive-grid');
  ab_driveSelIds.clear();updateDriveCount();
  grid.innerHTML='<div style="font-size:12px;color:var(--muted);padding:8px;grid-column:1/-1">Loading...</div>';
  try{
    const data=await api('GET','/api/drive/browse?folder='+encodeURIComponent(folder));
    if(!data.files.length){grid.innerHTML=`<div style="font-size:12px;color:var(--muted);padding:8px">${esc(data.message||'No files found.')}</div>`;return;}
    driveFiles=data.files;
    const typeIco=typeIcon(document.getElementById('ab-drive-type').value);
    grid.innerHTML=data.files.map(f=>`
      <div class="drive-card ${f.already_imported?'imported':''}" data-id="${f.id}" onclick="toggleDriveSel('${f.id}',this)">
        ${f.thumbnailLink
          ?`<img src="${esc(f.thumbnailLink)}" loading="lazy">`
          :`<div class="drive-icon">${typeIco}</div>`}
        <span class="drive-check">âœ“</span>
        ${f.already_imported?'<span class="drive-imported">in library</span>':''} 
        <div class="dname">${esc(f.name)}</div>
      </div>`).join('');
  }catch(err){grid.innerHTML=`<div style="font-size:12px;color:red;padding:8px">${esc(err.message)}</div>`;}
}
function toggleDriveSel(id,el){
  if(ab_driveSelIds.has(id))ab_driveSelIds.delete(id);else ab_driveSelIds.add(id);
  el.classList.toggle('sel',ab_driveSelIds.has(id));updateDriveCount();
}
function updateDriveCount(){
  const c=ab_driveSelIds.size;
  document.getElementById('ab-drive-count').textContent=c+' selected';
  document.getElementById('ab-drive-btn').disabled=c===0;
}
async function saveBlocksFromDrive(){
  if(!ab_driveSelIds.size)return;
  const type=document.getElementById('ab-drive-type').value;
  const category=document.getElementById('ab-drive-cat').value;
  const tags=document.getElementById('ab-drive-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const btn=document.getElementById('ab-drive-btn');btn.disabled=true;btn.textContent='Saving...';
  try{
    for(const id of ab_driveSelIds){
      const f=driveFiles.find(x=>x.id===id);
      await api('POST','/api/blocks/from-drive',{drive_file_id:id,file_name:f?f.name:id,file_mime:f?f.mimeType:'',thumbnail_url:f?f.thumbnailLink:'',type,title:f?f.name:id,category,tags});
    }
    closeM('m-addblock');toast(ab_driveSelIds.size+' block(s) added','ok');loadResearch();
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Add Selected â†’';}
}
// openBlockDetail â†’ see video section below
async function deleteBlock(id){
  if(!confirm('Delete this block?'))return;
  try{await api('DELETE','/api/blocks/'+id);closeM('m-block-detail');toast('Deleted','ok');loadResearch();}
  catch(err){toast(err.message,'err');}
}

// â•â•â• BLOCK PICKER â•â•â•
function openBlockPicker(entityType,entityId,typeFilter,title){
  pickerEntity=entityType;pickerEntityId=entityId;picker_sel.clear();
  document.getElementById('bkp-title').textContent=title||'Pick Blocks';
  document.getElementById('bkp-search').value='';
  document.getElementById('bkp-type').value=typeFilter&&typeFilter.length===1?typeFilter[0]:'';
  document.getElementById('bkp-sel-count').textContent='0 selected';
  document.getElementById('bkp-attach').disabled=true;
  loadPickerBlocks();openModal('m-block-picker');
}
async function loadPickerBlocks(){
  const p=new URLSearchParams();
  const s=document.getElementById('bkp-search').value;
  const t=document.getElementById('bkp-type').value;
  if(s)p.set('search',s);if(t)p.set('type',t);
  const blocks=await api('GET','/api/blocks?'+p);
  const grid=document.getElementById('bkp-grid');
  if(!blocks.length){grid.innerHTML='<div style="font-size:13px;color:var(--muted);padding:12px;text-align:center">No blocks found</div>';return;}
  grid.innerHTML=blocks.map(b=>{
    const hasImg=b.drive_file_id&&b.file_mime&&b.file_mime.startsWith('image/');
    return`<div class="bpm-card ${picker_sel.has(b.id)?'sel':''}" onclick="togglePickerSel(${b.id},this)">
      <div class="bpm-thumb">${
        b.thumbnail_url
          ? `<img src="${esc(b.thumbnail_url)}" loading="lazy" onerror="this.src='/api/drive/file/${b.drive_file_id}';this.onerror=null">`
          : hasImg 
            ? `<img src="/api/drive/file/${b.drive_file_id}" loading="lazy">`
            : `<span>${typeIcon(b.type)}</span>`
      }</div>
      <div class="bpm-label">${esc(b.title)}</div>
    </div>`;
  }).join('');
}
function togglePickerSel(id,el){
  if(picker_sel.has(id))picker_sel.delete(id);else picker_sel.add(id);
  el.classList.toggle('sel',picker_sel.has(id));
  const c=picker_sel.size;
  document.getElementById('bkp-sel-count').textContent=c+' selected';
  document.getElementById('bkp-attach').disabled=c===0;
}
async function confirmPickerAttach(){
  const btn=document.getElementById('bkp-attach');btn.disabled=true;btn.textContent='Attaching...';
  try{
    for(const blockId of picker_sel){
      await api('POST','/api/attachments',{block_id:blockId,entity_type:pickerEntity,entity_id:pickerEntityId});
    }
    closeM('m-block-picker');toast(picker_sel.size+' block(s) attached','ok');
    if(pickerEntity==='client'){const c=await api('GET','/api/clients/'+pickerEntityId);renderClientFile(c);}
    else if(pickerEntity==='prospect'){const p=await api('GET','/api/prospects/'+pickerEntityId);renderProspectFile(p);}
    else if(pickerEntity==='post'){await refreshPostModules();}
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='Attach â†’';}
}
async function detachBlock(attachmentId,entity){
  try{
    await api('DELETE','/api/attachments/'+attachmentId);toast('Removed','ok');
    if(entity==='client'){const c=await api('GET','/api/clients/'+CID);renderClientFile(c);}
    else if(entity==='prospect'){const p=await api('GET','/api/prospects/'+PROID);renderProspectFile(p);}
  }catch(err){toast(err.message,'err');}
}

// â•â•â• CALENDAR â•â•â•
// Calendar state
let calendarView = 'kanban'; // 'kanban' or 'month'
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let allPosts = [];

async function loadCalendar(){
  const p=new URLSearchParams();
  const plat=document.getElementById('cal-plat').value;
  if(plat)p.set('platform',plat);
  allPosts=await api('GET','/api/posts?'+p);
  
  if(calendarView === 'kanban'){
    loadKanbanView();
  } else {
    renderMonthView();
  }
}

function loadKanbanView(){
  ['idea','draft','ready','posted'].forEach(status=>{
    const col=document.getElementById('k-'+status);
    const items=allPosts.filter(p=>p.status===status);
    col.innerHTML=items.length?items.map(p=>`
      <div class="kcard" onclick="openPostBuilder(${p.id})">
        <div class="plat">${p.platform||''}${p.funnel_stage?` Â· ${p.funnel_stage.toUpperCase()}`:''}</div>
        <div class="goal">${esc(p.post_goal||'Untitled post')}</div>
        ${p.post_date?`<div class="kdate">ğŸ“… ${esc(p.post_date)}</div>`:''}
      </div>`).join('')
      :'<div style="font-size:11px;color:var(--muted);text-align:center;padding:8px">â€”</div>';
  });
}

function toggleCalendarView(view){
  calendarView = view;
  document.getElementById('view-toggle-kanban').classList.toggle('btn-dark', view === 'kanban');
  document.getElementById('view-toggle-month').classList.toggle('btn-dark', view === 'month');
  document.getElementById('kanban-view').style.display = view === 'kanban' ? 'grid' : 'none';
  document.getElementById('month-view').style.display = view === 'month' ? 'block' : 'none';
  
  if(view === 'month'){
    renderMonthView();
  }
}

function renderMonthView(){
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('month-title').textContent = `${monthNames[currentMonth]} ${currentYear}`;
  
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const prevLastDay = new Date(currentYear, currentMonth, 0);
  const startDay = firstDay.getDay(); // 0 = Sunday
  const daysInMonth = lastDay.getDate();
  
  const today = new Date();
  const isToday = (day) => {
    return day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
  };
  
  let html = '';
  
  // Day headers
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(day => {
    html += `<div class="month-day-header">${day}</div>`;
  });
  
  // Previous month days
  for(let i = startDay - 1; i >= 0; i--){
    const day = prevLastDay.getDate() - i;
    html += `<div class="month-day other-month"><div class="month-day-num">${day}</div></div>`;
  }
  
  // Current month days
  for(let day = 1; day <= daysInMonth; day++){
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dayPosts = allPosts.filter(p => p.post_date === dateStr);
    const todayClass = isToday(day) ? 'today' : '';
    
    html += `<div class="month-day ${todayClass}" data-date="${dateStr}">
      <div class="month-day-num">${day}</div>
      ${dayPosts.map(p => `
        <div class="month-post status-${p.status}" onclick="openPostBuilder(${p.id})">
          <div class="month-post-title">${esc(p.post_goal || 'Untitled')}</div>
          <div class="month-post-meta">${p.platform || ''}</div>
        </div>
      `).join('')}
      <div class="month-day-add" onclick="createPostForDate('${dateStr}')">+</div>
    </div>`;
  }
  
  // Next month days
  const totalCells = startDay + daysInMonth;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for(let day = 1; day <= remainingCells; day++){
    html += `<div class="month-day other-month"><div class="month-day-num">${day}</div></div>`;
  }
  
  document.getElementById('month-grid').innerHTML = html;
}

function changeMonth(delta){
  currentMonth += delta;
  if(currentMonth > 11){
    currentMonth = 0;
    currentYear++;
  } else if(currentMonth < 0){
    currentMonth = 11;
    currentYear--;
  }
  renderMonthView();
}

async function createPostForDate(dateStr){
  const p = await api('POST','/api/posts',{
    platform:'Instagram',
    status:'idea',
    post_date: dateStr
  });
  openPostBuilder(p.id);
}

async function openNewPost(){
  const p=await api('POST','/api/posts',{platform:'Instagram',status:'idea'});
  openPostBuilder(p.id);
}

// â•â•â• POST BUILDER â•â•â•
async function openPostBuilder(id){
  POST_ID=id;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  document.getElementById('v-post-builder').classList.add('on');
  const post=await api('GET','/api/posts/'+id);
  postModules=post.modules||[];
  allBlocks=await api('GET','/api/blocks');
  assistHistory=[];
  renderPostBuilder(post);
}
async function refreshPostModules(){
  const post=await api('GET','/api/posts/'+POST_ID);
  postModules=post.modules||[];
  renderPostStack();
}
function renderPostBuilder(post){
  const cs = post.content_structure || {};
  
  document.getElementById('pb-body').innerHTML=`
    <div class="pb-simple">
      <div class="pb-top">
        <h2>
          ${post.post_type === 'reel' ? 'ğŸ¥ Reel' : post.post_type === 'carousel' ? 'ğŸï¸ Carousel' : 'ğŸ“¸ Photo'}
          <button class="btn-link" onclick="setPostType('')" style="font-size:13px;margin-left:12px">Change type</button>
        </h2>
        <div class="pb-meta-row">
          <select onchange="updatePost('platform',this.value)" class="mini-select">
            <option ${post.platform==='Instagram'?'selected':''}>Instagram</option>
            <option ${post.platform==='TikTok'?'selected':''}>TikTok</option>
            <option ${post.platform==='LinkedIn'?'selected':''}>LinkedIn</option>
          </select>
          <select onchange="updatePost('funnel_stage',this.value)" class="mini-select">
            <option value="">Funnel</option>
            <option value="tof" ${post.funnel_stage==='tof'?'selected':''}>TOF</option>
            <option value="mof" ${post.funnel_stage==='mof'?'selected':''}>MOF</option>
            <option value="bof" ${post.funnel_stage==='bof'?'selected':''}>BOF</option>
          </select>
          <select onchange="updatePost('status',this.value)" class="mini-select">
            <option value="idea" ${post.status==='idea'?'selected':''}>Idea</option>
            <option value="draft" ${post.status==='draft'?'selected':''}>Draft</option>
            <option value="ready" ${post.status==='ready'?'selected':''}>Ready</option>
          </select>
          <input type="date" value="${post.post_date||''}" onchange="updatePost('post_date',this.value)" class="mini-select">
          <button class="btn btn-danger btn-sm" onclick="deletePost(${post.id})" style="margin-left:auto">Delete</button>
        </div>
      </div>
      
      <div class="pb-cols">
        <!-- Left: Reference Blocks -->
        <div class="pb-refs">
          <div class="pb-refs-head">
            <span style="font-weight:700">ğŸ“š Reference Material</span>
            <span style="font-size:11px;color:var(--muted)">Click to attach</span>
          </div>
          <input type="text" placeholder="Search your blocks..." class="ref-search" id="ref-search" oninput="filterRefBlocks()">
          <div id="ref-blocks" class="ref-blocks"></div>
          
          <div class="attached-blocks" id="attached-blocks" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"></div>
        </div>
        
        <!-- Middle: Caption Builder -->
        <div class="pb-caption">
          <div class="caption-section">
            <div class="cs-label">
              <span>ğŸª HOOK</span>
              <button class="btn-link" onclick="toggleHookSearch()" style="font-size:11px">Search hooks â†’</button>
            </div>
            <input 
              type="text" 
              placeholder="The line that stops the scroll..."
              value="${esc(cs.hook||'')}"
              oninput="updateCS('hook',this.value)"
              class="caption-input"
            >
          </div>
          
          <div class="caption-section">
            <div class="cs-label">ğŸ“ BODY</div>
            <textarea 
              placeholder="Context + value points..."
              oninput="updateCS('body',this.value)"
              class="caption-textarea"
              rows="8"
            >${esc(cs.body||'')}</textarea>
          </div>
          
          <div class="caption-section">
            <div class="cs-label">ğŸ¯ CTA</div>
            <textarea 
              placeholder="Save this, DM for details, link in bio..."
              oninput="updateCS('cta',this.value)"
              class="caption-textarea"
              rows="2"
            >${esc(cs.cta||'')}</textarea>
          </div>
          
          <div class="caption-section">
            <div class="cs-label">#ï¸âƒ£ HASHTAGS</div>
            <input 
              type="text"
              placeholder="#photography #portraits #headshots"
              value="${esc(cs.hashtags||'')}"
              oninput="updateCS('hashtags',this.value)"
              class="caption-input"
            >
          </div>
        </div>
        
        <!-- Right: Preview -->
        <div class="pb-preview-col">
          <div class="preview-box">
            <div class="preview-label">PREVIEW</div>
            <div class="preview-caption" id="preview-caption">Your caption will appear here...</div>
            <div class="preview-stats">
              <div><span class="stat-num" id="char-count">0</span><span class="stat-label">/2200</span></div>
              <div><span class="stat-num" id="line-count">0</span><span class="stat-label">lines</span></div>
              <div><span class="stat-num" id="hash-count">0</span><span class="stat-label">tags</span></div>
            </div>
            <button class="btn btn-dark" style="width:100%;margin-top:12px" onclick="copyCaption()">ğŸ“‹ Copy Caption</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hook Search Modal -->
    <div id="hook-search-modal" class="hook-modal" style="display:none">
      <div class="hook-modal-content">
        <div class="hook-modal-head">
          <div>
            <h3>Search Hooks</h3>
            <div id="hook-count-display" style="font-size:11px;color:var(--muted);margin-top:4px">Loading count...</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-link" onclick="reimportHooks()" style="font-size:11px">Re-import</button>
            <button onclick="toggleHookSearch()">âœ•</button>
          </div>
        </div>
        <input type="text" placeholder="Search 1000+ hooks..." id="hook-search-input" oninput="searchHooksModal(this.value)" class="hook-modal-search">
        <div id="hook-search-results" class="hook-modal-results"></div>
      </div>
    </div>`;
  
  loadRefBlocks();
  loadAttachedBlocks();
  updatePreview();
}

async function setPostType(type) {
  if (!type) {
    // Show type selector
    document.getElementById('pb-body').innerHTML = `
      <div style="max-width:700px;margin:60px auto">
        <h2 style="margin-bottom:30px">Choose content type</h2>
        <div class="type-grid">
          <div class="type-card" onclick="setPostType('photo')">
            <div class="type-icon">ğŸ“¸</div>
            <div class="type-title">Photo</div>
          </div>
          <div class="type-card" onclick="setPostType('carousel')">
            <div class="type-icon">ğŸï¸</div>
            <div class="type-title">Carousel</div>
          </div>
          <div class="type-card" onclick="setPostType('reel')">
            <div class="type-icon">ğŸ¥</div>
            <div class="type-title">Reel</div>
          </div>
        </div>
      </div>`;
    return;
  }
  
  await api('PATCH', `/api/posts/${POST_ID}`, { post_type: type });
  const post = await api('GET', `/api/posts/${POST_ID}`);
  renderPostBuilder(post);
}

function updateCS(field, value) {
  api('GET', `/api/posts/${POST_ID}`).then(post => {
    const cs = post.content_structure || {};
    cs[field] = value;
    api('PATCH', `/api/posts/${POST_ID}`, { content_structure: cs });
  });
  updatePreview();
}

function updatePreview() {
  const hook = document.querySelector('[oninput*="updateCS(\'hook\'"]')?.value || '';
  const body = document.querySelector('[oninput*="updateCS(\'body\'"]')?.value || '';
  const cta = document.querySelector('[oninput*="updateCS(\'cta\'"]')?.value || '';
  const hashtags = document.querySelector('[oninput*="updateCS(\'hashtags\'"]')?.value || '';
  
  const parts = [hook, body, cta, hashtags].filter(x => x.trim());
  const caption = parts.join('\n\n');
  
  document.getElementById('preview-caption').textContent = caption || 'Your caption will appear here...';
  document.getElementById('char-count').textContent = caption.length;
  document.getElementById('line-count').textContent = caption.split('\n').length;
  
  const hashMatches = hashtags.match(/#\w+/g);
  document.getElementById('hash-count').textContent = hashMatches ? hashMatches.length : 0;
}

function copyCaption() {
  const caption = document.getElementById('preview-caption').textContent;
  if (caption === 'Your caption will appear here...') return;
  navigator.clipboard.writeText(caption);
  toast('Copied!', 'ok');
}

let refBlocksData = [];
async function loadRefBlocks() {
  refBlocksData = await api('GET', '/api/blocks');
  filterRefBlocks();
}

function filterRefBlocks() {
  const search = (document.getElementById('ref-search')?.value || '').toLowerCase();
  const filtered = refBlocksData.filter(b => 
    !search || 
    b.title.toLowerCase().includes(search) ||
    (b.content_payload||'').toLowerCase().includes(search)
  );
  
  const html = filtered.slice(0, 20).map(b => {
    const icon = {pose:'ğŸ§',meme:'ğŸ˜‚',video:'ğŸ¥',sfx:'ğŸµ',note:'ğŸ“',url:'ğŸ”—',pdf:'ğŸ“„'}[b.type] || 'ğŸ“';
    return `
      <div class="ref-block" onclick="attachBlock(${b.id})">
        <div class="ref-icon">${icon}</div>
        <div class="ref-info">
          <div class="ref-title">${esc(b.title)}</div>
          ${b.content_payload ? `<div class="ref-snippet">${esc(b.content_payload.substring(0,60))}...</div>` : ''}
        </div>
      </div>`;
  }).join('');
  
  document.getElementById('ref-blocks').innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">No blocks found</div>';
}

let attachedBlockIds = [];
async function attachBlock(blockId) {
  if (attachedBlockIds.includes(blockId)) {
    attachedBlockIds = attachedBlockIds.filter(id => id !== blockId);
  } else {
    attachedBlockIds.push(blockId);
  }
  
  await api('PATCH', `/api/posts/${POST_ID}`, { 
    notes: JSON.stringify({ attached_blocks: attachedBlockIds })
  });
  
  loadAttachedBlocks();
}

function loadAttachedBlocks() {
  api('GET', `/api/posts/${POST_ID}`).then(post => {
    try {
      const notes = JSON.parse(post.notes || '{}');
      attachedBlockIds = notes.attached_blocks || [];
    } catch(e) {
      attachedBlockIds = [];
    }
    
    if (attachedBlockIds.length === 0) {
      document.getElementById('attached-blocks').innerHTML = '';
      return;
    }
    
    const attached = refBlocksData.filter(b => attachedBlockIds.includes(b.id));
    const icon = {pose:'ğŸ§',meme:'ğŸ˜‚',video:'ğŸ¥',sfx:'ğŸµ',note:'ğŸ“',url:'ğŸ”—',pdf:'ğŸ“„'};
    
    document.getElementById('attached-blocks').innerHTML = `
      <div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:8px">ATTACHED (${attached.length})</div>
      ${attached.map(b => `
        <div class="attached-block">
          <span>${icon[b.type] || 'ğŸ“'} ${esc(b.title)}</span>
          <button onclick="attachBlock(${b.id})" class="btn-xs">âœ•</button>
        </div>
      `).join('')}
    `;
  });
}

let hooksOffset = 0;
let hooksLoading = false;
let hooksHasMore = true;
let currentHookSearch = '';

function toggleHookSearch() {
  const modal = document.getElementById('hook-search-modal');
  if (modal.style.display === 'none') {
    modal.style.display = 'flex';
    document.getElementById('hook-search-input').value = '';
    document.getElementById('hook-search-input').focus();
    // Reset and load all hooks
    hooksOffset = 0;
    hooksHasMore = true;
    currentHookSearch = '';
    document.getElementById('hook-search-results').innerHTML = '';
    loadMoreHooks();
    loadHookCount();
    
    // Add scroll listener for infinite scroll
    const resultsDiv = document.getElementById('hook-search-results');
    resultsDiv.onscroll = () => {
      if (hooksLoading || !hooksHasMore) return;
      const { scrollTop, scrollHeight, clientHeight } = resultsDiv;
      if (scrollTop + clientHeight >= scrollHeight - 100) {
        loadMoreHooks();
      }
    };
  } else {
    modal.style.display = 'none';
  }
}

async function loadHookCount() {
  try {
    const data = await api('GET', '/api/hooks/count');
    document.getElementById('hook-count-display').textContent = `${data.count} hooks in database`;
  } catch(e) {
    document.getElementById('hook-count-display').textContent = '';
  }
}

async function reimportHooks() {
  if (!confirm('Delete ALL existing hooks and import fresh 1003 from viral_hooks.csv?')) return;
  
  document.getElementById('hook-count-display').textContent = 'Deleting old hooks...';
  
  try {
    const result = await api('POST', '/api/hooks/ingest');
    toast(`Fresh import complete! ${result.count} hooks loaded.`, 'ok');
    loadHookCount();
    
    // Reload hooks display
    hooksOffset = 0;
    hooksHasMore = true;
    currentHookSearch = '';
    document.getElementById('hook-search-results').innerHTML = '';
    loadMoreHooks();
  } catch(e) {
    toast('Import failed: ' + e.message, 'err');
    loadHookCount();
  }
}

async function loadMoreHooks() {
  if (hooksLoading || !hooksHasMore) return;
  
  hooksLoading = true;
  
  // Show loading indicator
  const resultsDiv = document.getElementById('hook-search-results');
  const loadingHTML = '<div class="hook-loading">Loading more hooks...</div>';
  resultsDiv.innerHTML += loadingHTML;
  
  const searchParam = currentHookSearch ? `&search=${encodeURIComponent(currentHookSearch)}` : '';
  const hooks = await api('GET', `/api/hooks?limit=50&offset=${hooksOffset}${searchParam}`);
  
  // Remove loading indicator
  const loadingEl = resultsDiv.querySelector('.hook-loading');
  if (loadingEl) loadingEl.remove();
  
  if (hooks.length === 0) {
    hooksHasMore = false;
    if (hooksOffset === 0) {
      resultsDiv.innerHTML = '<div class="hook-empty">No hooks found</div>';
    }
    hooksLoading = false;
    return;
  }
  
  if (hooks.length < 50) {
    hooksHasMore = false;
  }
  
  const hookHTML = hooks.map(h => `
    <div class="hook-modal-item" onclick="selectHookFromModal(\`${esc(h.text).replace(/`/g, '\\`')}\`)">
      ${esc(h.text)}
      ${h.category ? `<span class="hook-cat">${esc(h.category)}</span>` : ''}
    </div>
  `).join('');
  
  resultsDiv.innerHTML += hookHTML;
  hooksOffset += 50;
  hooksLoading = false;
}

let hookSearchTimeout;
async function searchHooksModal(query) {
  currentHookSearch = query.trim();
  
  // Reset for new search
  hooksOffset = 0;
  hooksHasMore = true;
  document.getElementById('hook-search-results').innerHTML = '';
  
  clearTimeout(hookSearchTimeout);
  hookSearchTimeout = setTimeout(() => {
    loadMoreHooks();
  }, 300);
}

function selectHookFromModal(hookText) {
  const hookInput = document.querySelector('[oninput*="updateCS(\'hook\'"]');
  if (hookInput) {
    hookInput.value = hookText;
    updateCS('hook', hookText);
  }
  toggleHookSearch();
}

async function addTextModule(type){
  try{const m=await api('POST','/api/posts/'+POST_ID+'/modules',{module_type:type});postModules.push(m);renderPostStack();}
  catch(err){toast(err.message,'err');}
}
async function removeModule(mid){
  try{await api('DELETE','/api/posts/'+POST_ID+'/modules/'+mid);postModules=postModules.filter(m=>m.id!==mid);renderPostStack();}
  catch(err){toast(err.message,'err');}
}
async function updateModuleContent(mid,val){
  try{await api('PATCH','/api/posts/'+POST_ID+'/modules/'+mid,{content:val});}
  catch(err){toast(err.message,'err');}
}
async function saveModuleOrder(){
  try{const order=postModules.map((m,i)=>({id:m.id,position:i}));await api('POST','/api/posts/'+POST_ID+'/modules/reorder',{order});}
  catch(err){/*silent*/}
}
function filterPbsBlocks(){
  const s=(document.getElementById('pbs-search')?.value||'').toLowerCase();
  const t=document.getElementById('pbs-type')?.value||'';
  let filtered=allBlocks.filter(b=>{
    if(t&&b.type!==t)return false;
    if(s&&!b.title.toLowerCase().includes(s)&&!(b.content_payload||'').toLowerCase().includes(s))return false;
    return true;
  }).slice(0,40);
  const el=document.getElementById('pbs-blocks');
  if(!el)return;
  if(!filtered.length){el.innerHTML='<div class="pbs-empty">No blocks found</div>';return;}
  el.innerHTML=filtered.map(b=>`
    <div class="pbs-block" onclick="addBlockAsModule(${b.id})">
      <span class="pi">${typeIcon(b.type)}</span>
      <div>
        <div class="pt">${esc(b.title)}</div>
        <div class="pm">${b.type}${b.funnel_stage?' Â· '+b.funnel_stage.toUpperCase():''}</div>
      </div>
    </div>`).join('');
}
async function addBlockAsModule(blockId){
  try{
    const b=allBlocks.find(x=>x.id===blockId)||await api('GET','/api/blocks/'+blockId);
    const m=await api('POST','/api/posts/'+POST_ID+'/modules',{module_type:b.type||'image',block_id:blockId});
    m.block_title=b.title;m.block_type=b.type;m.drive_file_id=b.drive_file_id;m.file_mime=b.file_mime;m.content_payload=b.content_payload;
    postModules.push(m);renderPostStack();toast('Added to stack','ok');
  }catch(err){toast(err.message,'err');}
}
async function updatePost(field,val){
  try{await api('PATCH','/api/posts/'+POST_ID,{[field]:val});}
  catch(err){toast(err.message,'err');}
}
async function deletePost(id){
  if(!confirm('Delete this post?'))return;
  try{await api('DELETE','/api/posts/'+id);showView('calendar');}
  catch(err){toast(err.message,'err');}
}

// â•â•â• HOOKS â•â•â•
async function openHooks(){loadHooks();openModal('m-hooks');}
async function loadHooks(){
  const p=new URLSearchParams();
  const s=document.getElementById('hook-search').value;
  const c=document.getElementById('hook-cat').value;
  if(s)p.set('search',s);if(c)p.set('category',c);
  const hooks=await api('GET','/api/hooks?'+p);
  const list=document.getElementById('hooks-list');
  if(!hooks.length){
    list.innerHTML=`<div style="padding:20px;text-align:center;font-size:13px;color:var(--muted)">No hooks yet.<br><button class="btn btn-ghost btn-sm" style="margin-top:10px" onclick="ingestHooksPdf()">Parse Hooks PDF from Drive</button></div>`;
    return;
  }
  list.innerHTML=hooks.map(h=>`
    <div class="hook-item" onclick="useHook(${JSON.stringify(h.text)})">
      <div class="hook-cat">${h.category||'general'}</div>
      ${esc(h.text)}
    </div>`).join('');
}
async function ingestHooksPdf(){
  const btn=document.getElementById('hooks-ingest-btn');
  btn.disabled=true;btn.textContent='Parsing...';
  try{
    const r=await api('POST','/api/hooks/ingest-pdf');
    toast(r.count+' hooks imported from '+r.file,'ok');loadHooks();
  }catch(err){toast(err.message,'err');}
  finally{btn.disabled=false;btn.textContent='â†» PDF';}
}
async function useHook(text){
  let hookMod=postModules.find(m=>m.module_type==='hook');
  if(!hookMod){
    hookMod=await api('POST','/api/posts/'+POST_ID+'/modules',{module_type:'hook',content:text});
    postModules.unshift(hookMod);
  }else{
    await api('PATCH','/api/posts/'+POST_ID+'/modules/'+hookMod.id,{content:text});
    hookMod.content=text;
  }
  closeM('m-hooks');renderPostStack();toast('Hook set','ok');
}

// â•â•â• AI ASSISTANT â•â•â•
async function sendAssist(){
  const input=document.getElementById('assist-input');
  const btn=document.getElementById('assist-btn');
  const msg=input.value.trim();if(!msg)return;
  input.value='';btn.disabled=true;btn.textContent='...';
  addAssistMsg(msg,'user');
  assistHistory.push({role:'user',content:msg});
  const post_context={modules:postModules.map(m=>({type:m.module_type,content:m.content||m.block_title||''}))};
  try{
    const r=await api('POST','/api/assist/post',{message:msg,history:assistHistory.slice(0,-1),post_context});
    addAssistMsg(r.reply,'ai');assistHistory.push({role:'assistant',content:r.reply});
  }catch(err){addAssistMsg('Could not reach assistant.','ai');}
  finally{btn.disabled=false;btn.textContent='â†’';input.focus();}
}
function quickAssist(msg){document.getElementById('assist-input').value=msg;sendAssist();}
function addAssistMsg(text,role){
  const msgs=document.getElementById('assist-msgs');if(!msgs)return;
  const d=document.createElement('div');
  d.className='am am-'+(role==='user'?'user':'ai');
  d.textContent=text;msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}

// â•â•â• INIT â•â•â•
async function repairThumbnails(){
  const btn = document.getElementById('repair-btn');
  btn.disabled=true; btn.textContent='Fixing...';
  try {
    const r = await api('POST','/api/blocks/repair-thumbnails');
    toast(`Fixed: ${r.images_fixed} images, ${r.videos_fixed} videos, ${r.mime_fixed} mime types`,'ok');
    loadResearch();
  } catch(err){ toast(err.message,'err'); }
  finally { btn.disabled=false; btn.textContent='ğŸ”§ Fix Thumbs'; }
}
async function syncDrive(){
  const btn=document.getElementById('sync-btn');
  btn.disabled=true;btn.textContent='Syncing...';
  try{
    const r=await api('POST','/api/drive/sync');
    console.log('Sync results:',JSON.stringify(r.results));
    const folderSummary=r.results.map(x=>x.folder+': '+(x.new||0)+' new').join(' | ');
    const msg=r.imported>0
      ?r.imported+' new block'+(r.imported!==1?'s':'')+' imported'
      :'Up to date ('+r.skipped+' already in library)';
    toast(msg,'ok');
    console.log(folderSummary);
    loadResearch();
  }catch(err){
    console.error('Sync error:',err);
    toast('Sync failed: '+err.message,'err');
  }
  finally{btn.disabled=false;btn.textContent='â†» Sync Drive';}
}

async function cleanupDeleted(){
  const btn=document.getElementById('cleanup-btn');
  if(!confirm('This will remove blocks for files that were deleted from Google Drive. Continue?')) return;
  btn.disabled=true;btn.textContent='Cleaning...';
  try{
    const r=await api('POST','/api/drive/cleanup');
    const msg=r.deleted>0
      ?`Removed ${r.deleted} deleted file${r.deleted!==1?'s':''}`
      :'No deleted files found';
    toast(msg,'ok');
    loadResearch();
  }catch(err){
    console.error('Cleanup error:',err);
    toast('Cleanup failed: '+err.message,'err');
  }
  finally{btn.disabled=false;btn.textContent='ğŸ—‘ï¸ Clean Up';}
}

async function syncClients(){
  try{
    const r=await api('POST','/api/drive/sync-clients');
    const msg=r.created>0||r.updated>0
      ?`${r.created} new, ${r.updated} updated (${r.total} total folders)`
      :'No new client folders found';
    toast(msg,'ok');
    loadPipeline();
  }catch(err){
    console.error('Client sync error:',err);
    toast('Client sync failed: '+err.message,'err');
  }
}

async function syncDiscovery(){
  try{
    const r=await api('POST','/api/drive/sync-discovery');
    const msg=r.created>0||r.updated>0
      ?`${r.created} new, ${r.updated} updated (${r.total} total folders)`
      :'No new discovery folders found';
    toast(msg,'ok');
    loadDiscovery();
  }catch(err){
    console.error('Discovery sync error:',err);
    toast('Discovery sync failed: '+err.message,'err');
  }
}

// Auto-sync handled inside loadResearch


// â•â•â• VIDEO INGEST â•â•â•
function checkVideoUrl(){
  const url = document.getElementById('ab-url').value;
  const isVideo = /tiktok\.com|instagram\.com\/reel|instagram\.com\/p\/|youtube\.com|youtu\.be|twitter\.com|x\.com/.test(url);
  const typeEl = document.getElementById('ab-url-type');
  const hint = document.getElementById('ab-url-video-hint');
  if(isVideo){
    typeEl.value = 'video';
    hint.style.display = 'block';
  } else {
    hint.style.display = 'none';
  }
}

async function handleUrlIngest(){
  const type = document.getElementById('ab-url-type').value;
  if(type === 'video'){
    await ingestVideo();
  } else {
    await ingestUrl();
  }
}

async function ingestVideo(){
  const url = document.getElementById('ab-url').value.trim();
  if(!url){ toast('URL required','err'); return; }

  const btn = document.getElementById('ab-url-btn');
  const progress = document.getElementById('ab-url-progress');
  const actions = document.getElementById('ab-url-actions');
  const stepEl = document.getElementById('ab-prog-step');
  const msgEl = document.getElementById('ab-prog-msg');

  btn.disabled = true;
  progress.style.display = 'block';
  actions.style.opacity = '0.4';

  const stepLabels = {
    download: 'Downloading video',
    audio: 'Extracting audio',
    screenshots: 'Capturing frames',
    uploading: 'Uploading to Drive',
    transcribe: 'Transcribing with Whisper',
    summarize: 'Summarizing with Claude',
    saving: 'Saving to library',
    done: 'Done'
  };

  try {
    const response = await fetch('/api/blocks/ingest-video', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        url,
        funnel_stage: document.getElementById('ab-url-funnel').value,
        category: document.getElementById('ab-url-cat').value,
        tags: document.getElementById('ab-url-tags').value
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while(true){
      const { done, value } = await reader.read();
      if(done) break;
      const text = decoder.decode(value);
      const lines = text.split('\n').filter(l => l.startsWith('data: '));
      for(const line of lines){
        try{
          const data = JSON.parse(line.slice(6));
          if(data.error){ throw new Error(data.error); }
          if(data.step){
            stepEl.textContent = stepLabels[data.step] || data.step;
            msgEl.textContent = data.msg || '';
          }
          if(data.done){
            closeM('m-addblock');
            toast('Video block created â€” transcript, summary & frames ready','ok');
            loadResearch();
          }
        } catch(parseErr){
          if(parseErr.message !== 'Unexpected token'){
            toast(parseErr.message,'err');
            break;
          }
        }
      }
    }
  } catch(err){
    toast(err.message,'err');
  } finally {
    btn.disabled = false;
    progress.style.display = 'none';
    actions.style.opacity = '1';
  }
}

// â•â•â• RICH BLOCK DETAIL - VIDEO â•â•â•
function formatDuration(secs){
  if(!secs)return'';
  const m=Math.floor(secs/60),s=secs%60;
  return m+'m '+(s<10?'0':'')+s+'s';
}

async function openBlockDetail(id){
  const b = await api('GET','/api/blocks/'+id);
  document.getElementById('bd-title').textContent = b.title;

  if(b.type === 'video'){
    renderVideoBlock(b);
  } else {
    renderGenericBlock(b);
  }
  openModal('m-block-detail');
}

function renderVideoBlock(b){
  const m = b.metadata || {};
  const frames = m.screenshot_frames || [];
  const keyPoints = m.key_points || [];
  const firstFrame = frames[0];

  document.getElementById('bd-body').innerHTML = `
    <div class="video-block">
      <div class="vb-hero">
        ${firstFrame
          ? `<img src="/api/drive/file/${firstFrame.id}" onerror="this.src=''">`
          : `<div style="height:160px;display:flex;align-items:center;justify-content:center;font-size:48px">ğŸ¬</div>`}
        <span class="vb-platform">${esc(m.platform||'Video')}</span>
        ${m.duration?`<span class="vb-dur">${formatDuration(m.duration)}</span>`:''}
      </div>

      <div class="vb-meta">
        <div class="vb-oneliner">${esc(m.one_liner||b.title)}</div>
        ${m.relevance?`<div class="vb-relevance">${esc(m.relevance)}</div>`:''}
        ${b.source_url?`<div class="vb-source">Source: <a href="${esc(b.source_url)}" target="_blank">${esc(b.source_url.substring(0,60))}â€¦</a></div>`:''}
      </div>

      ${keyPoints.length?`
        <div class="vb-section">
          <div class="vb-section-head">Key Points</div>
          <div class="kp-list">
            ${keyPoints.map((pt,i)=>`
              <div class="kp-item">
                <span class="kp-num">${i+1}</span>
                <span>${esc(pt)}</span>
              </div>`).join('')}
          </div>
        </div>`:''}

      ${frames.length?`
        <div class="vb-section">
          <div class="vb-section-head">${frames.length} Frames</div>
          <div class="shots-strip">
            ${frames.map((f,i)=>`
              <div class="shot-frame">
                <img src="/api/drive/file/${f.id}" loading="lazy" onerror="this.style.opacity='.2'">
                <div class="shot-label">${esc(f.label||('Frame '+(i+1)))}</div>
              </div>`).join('')}
          </div>
        </div>`:''}

      ${b.content_payload?`
        <div class="vb-section">
          <div class="vb-section-head" style="cursor:pointer" onclick="this.nextElementSibling.classList.toggle('hide')">
            Transcript <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--muted)">(click to expand)</span>
          </div>
          <div class="transcript-block hide">${esc(b.content_payload)}</div>
        </div>`:''}

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        ${(b.tags||[]).map(t=>`<span class="tag t-lead">${esc(t)}</span>`).join('')}
        ${b.funnel_stage?`<span class="tag t-lead">${b.funnel_stage.toUpperCase()}</span>`:''}
        ${b.category?`<span class="tag t-lead">${esc(b.category)}</span>`:''}
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn btn-danger btn-sm" onclick="deleteBlock(${b.id})">Delete Block</button>
      </div>
    </div>`;
}

function renderGenericBlock(b){
  const hasImg = b.drive_file_id && b.file_mime && b.file_mime.startsWith('image/');
  const hasVideo = b.drive_file_id && b.file_mime && b.file_mime.startsWith('video/');
  const isNote = ['note','conversation','transcript'].includes(b.type);
  const isPdf = b.type === 'pdf';
  const needsSummarize = (isNote || isPdf) && b.content_payload && b.content_payload.length > 100;

  document.getElementById('bd-body').innerHTML = `
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
      <span class="tag t-lead">${b.type}</span>
      ${b.category?`<span class="tag t-lead">${esc(b.category)}</span>`:''}
      ${b.funnel_stage?funnelBadge(b.funnel_stage):''}
      ${(b.tags||[]).map(t=>`<span class="tag t-lead">${esc(t)}</span>`).join('')}
    </div>
    ${hasVideo?`
      <video controls style="width:100%;border-radius:10px;margin-bottom:12px;background:#000;max-height:420px" preload="metadata">
        <source src="/api/drive/file/${b.drive_file_id}" type="${esc(b.file_mime)}">
      </video>`:''
    }
    ${hasImg?`<img src="/api/drive/file/${b.drive_file_id}" style="max-width:100%;border-radius:8px;margin-bottom:12px;max-height:420px;object-fit:contain;width:100%">`:'' }
    ${b.thumbnail_url&&!hasImg&&!hasVideo?`<img src="${esc(b.thumbnail_url)}" style="max-width:100%;border-radius:8px;margin-bottom:12px;max-height:240px;object-fit:contain">`:'' }
    ${b.source_url?`<div style="margin-bottom:10px"><a href="${esc(b.source_url)}" target="_blank" style="color:var(--accent);font-size:13px">â†— Open source</a></div>`:''}
    ${needsSummarize?`
      <div id="blk-summary-${b.id}" style="margin-bottom:12px">
        <button class="btn btn-ghost btn-sm" onclick="summarizeBlock(${b.id})">âœ¨ Summarize with AI</button>
      </div>`:''
    }
    ${b.content_payload?`
      <div style="margin-bottom:6px;font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px">Content</div>
      <div class="transcript-block">${esc(b.content_payload)}</div>`:''
    }
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px">
      ${b.drive_file_id?`<button class="btn btn-ghost btn-sm" onclick="window.open('/api/drive/file/${b.drive_file_id}','_blank')">â†— Open file</button>`:''}
      <button class="btn btn-danger btn-sm" onclick="deleteBlock(${b.id})">Delete Block</button>
    </div>`;
}

async function summarizeBlock(id){
  const btn = document.querySelector(`#blk-summary-${id} button`);
  btn.disabled=true; btn.textContent='Summarizing...';
  try {
    const r = await api('POST', `/api/blocks/${id}/summarize`);
    document.getElementById(`blk-summary-${id}`).innerHTML = `
      <div style="background:var(--surface-2);border-radius:10px;padding:14px;border-left:3px solid var(--accent)">
        <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">AI Summary</div>
        <div style="font-size:13px;line-height:1.7;white-space:pre-wrap">${esc(r.summary||r.content||'No summary returned')}</div>
      </div>`;
  } catch(err){ btn.disabled=false; btn.textContent='âœ¨ Summarize with AI'; toast(err.message,'err'); }
}

loadPipeline();

// â”€â”€ Ask Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAskLibrary(){
  document.getElementById('ask-input').value='';
  openModal('m-ask-library');
  setTimeout(()=>document.getElementById('ask-input').focus(),100);
}

async function askLibrary(){
  const q = document.getElementById('ask-input').value.trim();
  if(!q) return;
  const btn = document.getElementById('ask-btn');
  const status = document.getElementById('ask-status');
  const history = document.getElementById('ask-history');
  btn.disabled=true; btn.textContent='Thinking...';
  status.style.display='block'; status.textContent='Reading your library...';
  history.style.display='flex';

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.style.cssText='align-self:flex-end;background:var(--accent);color:#fff;border-radius:12px 12px 2px 12px;padding:10px 14px;font-size:13px;max-width:85%;line-height:1.6';
  userMsg.textContent=q;
  history.appendChild(userMsg);
  history.scrollTop=history.scrollHeight;
  document.getElementById('ask-input').value='';

  try {
    const r = await api('POST','/api/library/ask',{question:q});
    
    // Add AI answer
    const aiMsg = document.createElement('div');
    aiMsg.style.cssText='align-self:flex-start;background:var(--surface-2);border-radius:2px 12px 12px 12px;padding:12px 14px;font-size:13px;max-width:90%;line-height:1.7;white-space:pre-wrap;border:1px solid var(--border)';
    aiMsg.textContent=r.answer;

    if(r.sources && r.sources.length){
      const srcs = document.createElement('div');
      srcs.style.cssText='margin-top:10px;padding-top:8px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:6px';
      srcs.innerHTML='<span style="font-size:10px;color:var(--muted);width:100%;font-weight:600;letter-spacing:.4px;text-transform:uppercase">Sources</span>' +
        r.sources.map(s=>`<button onclick="openBlockDetail(${s.id});closeM('m-ask-library')" style="background:var(--surface-3);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:11px;cursor:pointer;color:var(--text)">${esc(s.title)}</button>`).join('');
      aiMsg.appendChild(srcs);
    }

    const meta = document.createElement('div');
    meta.style.cssText='font-size:10px;color:var(--muted);margin-top:6px';
    meta.textContent=`â†‘ Based on ${r.block_count} blocks in your library`;
    aiMsg.appendChild(meta);

    history.appendChild(aiMsg);
    history.scrollTop=history.scrollHeight;
    status.style.display='none';
  } catch(err){
    toast(err.message,'err');
    status.style.display='none';
  }
  btn.disabled=false; btn.textContent='Ask â†’';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLEGE REVIEW FUNCTIONS (v3.37)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
</script>
<!-- Ask Library Modal -->
<div class="mbg off" id="m-ask-library">
  <div class="modal" style="max-width:680px">
    <div class="mh"><h2>Ask your Library ğŸ§ </h2><button class="mx" onclick="closeM('m-ask-library')">âœ•</button></div>
    <div class="mb" style="display:flex;flex-direction:column;gap:12px">
      <p style="font-size:13px;color:var(--muted);margin:0">Ask anything â€” Claude reads your actual research blocks, transcripts, and notes to answer. No hallucination, citations included.</p>
      <div id="ask-history" style="display:none;max-height:380px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding-bottom:4px"></div>
      <div style="display:flex;gap:8px">
        <textarea id="ask-input" placeholder="e.g. What posing tips do I have for nervous clients? What did that Canva video say about composition?" style="flex:1;min-height:72px;resize:vertical;font-size:13px;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:10px;color:var(--text);font-family:inherit" onkeydown="if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){askLibrary();return false}"></textarea>
        <button class="btn btn-dark" id="ask-btn" onclick="askLibrary()" style="align-self:flex-end;white-space:nowrap">Ask â†’</button>
      </div>
      <div id="ask-status" style="font-size:11px;color:var(--muted);display:none"></div>
    </div>
  </div>
</div>
</body>
</html>
